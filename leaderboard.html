<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>æ’è¡Œæ¦œ</title>
    <link rel="stylesheet" href="style.css">
    <script src="api.js"></script>
</head>

<body>
    <header class="site-header">
        <div class="header-inner">
            <div class="header-left">
                <div class="header-logo">ï£¿ TC2 DB</div>
                <nav class="header-nav">
                    <a href="home.html" class="nav-link">é¦–é </a>
                    <a href="leaderboard.html" class="nav-link nav-link-active">æ’è¡Œæ¦œ</a>
                    <a href="trade.html" class="nav-link">äº¤æ˜“ä¸­å¿ƒ</a>
                    <a href="schedule.html" class="nav-link">è³½ç¨‹è¡¨</a>
                </nav>
            </div>
            <div class="header-right">
                <div class="profile-icon" id="nav-profile-icon"></div>
            </div>
        </div>
    </header>

    <div class="app">
        <div class="top-bar">
            <h1>æ’è¡Œæ¦œ</h1>
        </div>

        <div class="card-container">
            <div class="card" id="card-score">
                <h2>ç©åˆ†æ’è¡Œæ¦œ</h2>
                <p>ä¾ç©å®¶å¹´åº¦ç¸½ç©åˆ†æ’åºï¼Œä¸¦å¯æŸ¥è©¢ç©å®¶åæ¬¡ã€‚</p>
            </div>

            <div class="card" id="card-track">
                <h2>è³½é“ç´€éŒ„</h2>
                <p>æŸ¥çœ‹å„è³½é“æ’è¡Œæ¦œï¼Œæˆ–æŸ¥è©¢ç‰¹å®šç©å®¶çš„è³½é“ç´€éŒ„ã€‚</p>
            </div>
        </div>

        <div id="year-tabs" class="year-tabs">
        </div>

        <section id="score-section" style="display:none; margin-top: 30px;">
            <div class="section-row">
                <div class="panel" style="flex:1;">
                    <div class="field-label">æŸ¥è©¢ç©å®¶åæ¬¡ï¼ˆè¼¸å…¥å¸³è™Ÿï¼‰</div>
                    <div class="inline-input">
                        <input type="text" id="rank-search-name">
                        <button id="rank-search-btn">æŸ¥è©¢</button>
                    </div>
                    <p id="rank-search-result" class="hint-text"></p>
                </div>
            </div>

            <table id="score-table">
                <colgroup>
                    <col style="width:10%;">
                    <col style="width:25%;">
                    <col style="width:15%;">
                    <col style="width:15%;">
                    <col style="width:15%;">
                    <col style="width:20%;">
                </colgroup>
                <thead>
                    <tr>
                        <th>åæ¬¡</th>
                        <th>å¸³è™Ÿ</th>
                        <th>åˆ†ç«™å† è»</th>
                        <th>ä¸Šçå°</th>
                        <th>å®Œè³½</th>
                        <th>ç©åˆ†</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="track-section" style="display:none; margin-top: 30px;">
            <div class="section-row">
                <div class="panel">
                    <div class="field-label">é¸æ“‡è³½é“</div>
                    <select id="track-select" style="width:100%;"></select>
                </div>

                <div class="panel">
                    <div class="field-label">æŸ¥è©¢ç©å®¶çš„è³½é“ç´€éŒ„</div>
                    <div class="inline-input">
                        <input type="text" id="track-player-name" placeholder="è¼¸å…¥å¸³è™Ÿ">
                        <button id="track-player-btn">æŸ¥è©¢</button>
                    </div>
                </div>
            </div>

            <div id="track-info-display" style="
                display: none; 
                margin-top: 20px; 
                background: #fff; 
                padding: 20px; 
                border-radius: 12px; 
                box-shadow: 0 2px 6px rgba(0,0,0,0.04);
                align-items: center; 
                gap: 24px;
                border: 1px solid rgba(0,0,0,0.04);
            ">
                <img id="track-img" src="" alt="Track Image" style="
                    width: 320px; 
                    height: 180px; 
                    object-fit: cover; 
                    border-radius: 8px; 
                    background-color: #eee;
                    border: 1px solid #ddd;
                ">

                <div style="flex: 1;">
                    <h3 id="track-name-title" style="margin: 0 0 12px 0; font-size: 22px; color: #333;">--</h3>
                    <div style="font-size: 16px; color: #555; line-height: 1.6;">
                        <p style="margin: 0;">
                            <strong>è³½é“é•·åº¦ï¼š</strong> <span id="track-length">--</span>
                        </p>
                    </div>
                </div>
            </div>

            <table id="track-table" style="margin-top: 20px;">
                <colgroup>
                    <col style="width:10%;">
                    <col style="width:20%;">
                    <col style="width:25%;">
                    <col style="width:20%;">
                    <col style="width:25%;">
                </colgroup>
                <thead>
                    <tr>
                        <th>åæ¬¡</th>
                        <th>å¸³è™Ÿ</th>
                        <th>ä½¿ç”¨è»Šè¼›</th>
                        <th>ç¸½æ™‚é–“</th>
                        <th>æ—¥æœŸ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <h4 style="margin-top:30px; margin-bottom:10px;">ç©å®¶å„è³½é“ç¸½è¦½ (æŸ¥è©¢çµæœ)</h4>

            <table id="track-player-table">
                <colgroup>
                    <col style="width:10%;">
                    <col style="width:15%;">
                    <col style="width:10%;">
                    <col style="width:20%;">
                    <col style="width:10%;">
                    <col style="width:15%;">
                    <col style="width:20%;">
                </colgroup>
                <thead>
                    <tr>
                        <th>çé‡‘</th>
                        <th>è³½é“</th>
                        <th>å¸³è™Ÿ</th>
                        <th>ä½¿ç”¨è»Šè¼›</th>
                        <th>åæ¬¡</th>
                        <th>ç¸½æ™‚é–“</th>
                        <th>æ—¥æœŸ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <div id="player-modal-overlay" class="modal-overlay"></div>
        <div id="player-modal" class="modal">
            <div class="modal-header">
                <h3>ç©å®¶è³‡æ–™</h3>
                <button id="player-modal-close" class="modal-close">Ã—</button>
            </div>
            <div id="player-modal-content" class="modal-content"></div>
        </div>
    </div>

    <script>
        // 1. åŸºç¤é©—è­‰èˆ‡å°è¦½åˆ—è¨­å®š
        const playerId = localStorage.getItem("playerId");
        if (!playerId) { window.location.href = "index.html"; }

        const navIcon = document.getElementById("nav-profile-icon");
        if (navIcon) {
            const username = localStorage.getItem("username") || "ä½ ";
            navIcon.textContent = username.charAt(0).toUpperCase();
            navIcon.addEventListener("click", () => { window.location.href = "profile.html"; });
        }

        // 2. å–å¾—é é¢å…ƒç´ 
        const cardScore = document.getElementById("card-score");
        const cardTrack = document.getElementById("card-track");
        const scoreSection = document.getElementById("score-section");
        const trackSection = document.getElementById("track-section");
        const yearTabsContainer = document.getElementById("year-tabs");
        const trackSelect = document.getElementById("track-select");

        // ç‹€æ…‹è®Šæ•¸
        let currentYear = null;
        let currentMode = null; // 'score' or 'track'

        // 3. ç¶å®šå¡ç‰‡åˆ‡æ›äº‹ä»¶
        cardScore.addEventListener("click", () => {
            switchMode('score');
        });

        cardTrack.addEventListener("click", () => {
            switchMode('track');
        });

        // åˆ‡æ›æ¨¡å¼å‡½å¼
        function switchMode(mode) {
            currentMode = mode;
            if (mode === 'score') {
                scoreSection.style.display = "block";
                trackSection.style.display = "none";
                yearTabsContainer.style.display = "flex"; // é¡¯ç¤ºå¹´ä»½
                if (!currentYear) initYearTabs(); // å¦‚æœé‚„æ²’è¼‰å…¥å¹´ä»½ï¼Œè¼‰å…¥ä¹‹
            } else {
                scoreSection.style.display = "none";
                trackSection.style.display = "block";
                yearTabsContainer.style.display = "none"; // è³½é“ç´€éŒ„é€šå¸¸çœ‹å…¨å¹´åº¦æˆ–ä¸éœ€è¦å¹´ä»½æ¢
                initTrackSelect(); // åˆå§‹åŒ–è³½é“é¸å–®
            }
        }

        // 4. --- ç©åˆ†æ’è¡Œæ¦œé‚è¼¯ ---

        function initYearTabs() {
            apiGetYears().then(years => {
                yearTabsContainer.innerHTML = "";

                // åŠ ä¸Š "ç”Ÿæ¶¯ç¸½è¨ˆ" é¸é …
                years.push("all");

                // é è¨­é¸ä¸­æœ€å¾Œä¸€å€‹å¹´ä»½ (æˆ– all)
                const defaultYear = years.includes(2024) ? 2024 : years[years.length - 1];
                currentYear = defaultYear;

                years.forEach(y => {
                    const div = document.createElement("div");
                    div.className = "year-tab";
                    div.innerText = (y === 'all') ? "ç”Ÿæ¶¯ç¸½è¨ˆ" : y;
                    if (y == currentYear) div.classList.add("active");

                    div.addEventListener("click", () => {
                        // ç§»é™¤å…¶ä»– active
                        document.querySelectorAll(".year-tab").forEach(t => t.classList.remove("active"));
                        div.classList.add("active");
                        currentYear = y;
                        loadScoreLeaderboard(y);
                    });
                    yearTabsContainer.appendChild(div);
                });

                // åˆå§‹è¼‰å…¥
                loadScoreLeaderboard(currentYear);
            });
        }

        function loadScoreLeaderboard(year) {
            const tbody = document.querySelector("#score-table tbody");
            tbody.innerHTML = `<tr><td colspan="6">è¼‰å…¥ä¸­...</td></tr>`;

            apiGetLeaderboardByYear(year).then(data => {
                tbody.innerHTML = "";
                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6">è©²å¹´åº¦å°šç„¡ç©åˆ†ç´€éŒ„</td></tr>`;
                    return;
                }

                data.forEach(row => {
                    const tr = document.createElement("tr");
                    // â˜… ä¿®æ”¹ä¸‹é¢é€™ä¸€è¡Œï¼šçµ¦ username åŠ ä¸Šè—è‰²é€£çµæ¨£å¼å’Œ onclick äº‹ä»¶
                    tr.innerHTML = `
                <td>${row.rank}</td>
                <td style="color:#0071e3; cursor:pointer; font-weight:500;" 
                    onclick="openPlayerModal('${row.username}')">
                    ${row.username}
                </td>
                <td>${row.winCount || 0}</td>
                <td>${row.podiumCount || 0}</td>
                <td>${row.raceCount || 0}</td>
                <td>${row.score}</td>
            `;
                    tbody.appendChild(tr);
                });
            });
        }

        // æœå°‹æ’å
        const searchRankBtn = document.getElementById("rank-search-btn");
        searchRankBtn.addEventListener("click", () => {
            const name = document.getElementById("rank-search-name").value;
            const resultP = document.getElementById("rank-search-result");
            if (!name || !currentYear) return;

            apiGetPlayerRankByYear(currentYear, name).then(res => {
                if (res) {
                    resultP.innerText = `ç©å®¶ ${name} åœ¨ ${currentYear === 'all' ? 'ç”Ÿæ¶¯' : currentYear} çš„æ’åç‚ºï¼šç¬¬ ${res.rank} å (ç©åˆ†: ${res.score})`;
                    resultP.style.color = "#0071e3";
                } else {
                    resultP.innerText = "æ‰¾ä¸åˆ°è©²ç©å®¶è³‡æ–™æˆ–ç„¡åƒè³½ç´€éŒ„";
                    resultP.style.color = "red";
                }
            });
        });


        // 5. --- è³½é“ç´€éŒ„é‚è¼¯ ---

        let isTrackLoaded = false;
        function initTrackSelect() {
            if (isTrackLoaded) return;
            apiGetTrackNames().then(names => {
                trackSelect.innerHTML = `<option value="" disabled selected>è«‹é¸æ“‡è³½é“</option>`;
                names.forEach(name => {
                    const opt = document.createElement("option");
                    opt.value = name;
                    opt.innerText = name;
                    trackSelect.appendChild(opt);
                });
                isTrackLoaded = true;
            });
        }

        // ç•¶é¸æ“‡è³½é“æ™‚
        trackSelect.addEventListener("change", (e) => {
            const trackName = e.target.value;
            loadTrackInfoAndLeaderboard(trackName);
        });

        function loadTrackInfoAndLeaderboard(trackName) {
            // ... (å‰ç•¥ï¼Œè³½é“è³‡è¨Šé¡¯ç¤ºéƒ¨åˆ†ä¸ç”¨å‹•) ...

            // 2. è¼‰å…¥æ’è¡Œæ¦œ
            const tbody = document.querySelector("#track-table tbody");
            tbody.innerHTML = `<tr><td colspan="5">è¼‰å…¥ä¸­...</td></tr>`;

            apiGetTrackLeaderboard(trackName, 'all').then(data => {
                tbody.innerHTML = "";
                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5">å°šç„¡ç´€éŒ„</td></tr>`;
                    return;
                }

                data.forEach(row => {
                    const tr = document.createElement("tr");
                    // â˜… ä¿®æ”¹ä¸‹é¢é€™ä¸€è¡Œï¼šåŒæ¨£çµ¦ username åŠ ä¸Š onclick
                    tr.innerHTML = `
                <td>${row.rank}</td>
                <td style="color:#0071e3; cursor:pointer; font-weight:500;" 
                    onclick="openPlayerModal('${row.username}')">
                    ${row.username}
                </td>
                <td>${row.carName || '-'}</td>
                <td style="font-family:monospace; font-weight:bold;">${row.bestTime}</td>
                <td>${row.date || '-'}</td>
            `;
                    tbody.appendChild(tr);
                });
            });
        }

        // æŸ¥è©¢ç‰¹å®šç©å®¶çš„è³½é“ç¸½è¦½
        const trackPlayerBtn = document.getElementById("track-player-btn");
        trackPlayerBtn.addEventListener("click", () => {
            const pName = document.getElementById("track-player-name").value.trim();
            if (!pName) return;

            const tbody = document.querySelector("#track-player-table tbody");
            tbody.innerHTML = `<tr><td colspan="7">æŸ¥è©¢ä¸­...</td></tr>`;

            apiGetPlayerTrackSummary(pName).then(data => {
                tbody.innerHTML = "";
                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7">è©²ç©å®¶ç„¡åƒè³½ç´€éŒ„</td></tr>`;
                    return;
                }

                // ä¾è³½é“åç¨±æ’åº
                data.sort((a, b) => a.trackName.localeCompare(b.trackName));

                data.forEach(r => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td style="color:green;">$${r.prize}</td>
                        <td>${r.trackName}</td>
                        <td>${r.username}</td>
                        <td>${r.carName}</td>
                        <td>${r.rank > 0 ? r.rank : '-'}</td>
                        <td style="font-family:monospace;">${r.bestTime}</td>
                        <td>${r.date || '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        });
        // --- 6. ç©å®¶è©³ç´°è³‡æ–™å½ˆçª—é‚è¼¯ (æ–°å¢) ---

        // é–‹å•Ÿå½ˆçª—
        function openPlayerModal(username) {
            const modal = document.getElementById("player-modal");
            const overlay = document.getElementById("player-modal-overlay");
            const content = document.getElementById("player-modal-content");

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            content.innerHTML = '<div style="text-align:center; padding:30px; color:#888;">è³‡æ–™è®€å–ä¸­...</div>';
            modal.classList.add("show");
            overlay.classList.add("show");

            apiGetPlayerDetail(username).then(data => {
                if (!data) {
                    content.innerHTML = '<div style="text-align:center; padding:20px;">æ‰¾ä¸åˆ°è©²ç©å®¶è³‡æ–™</div>';
                    return;
                }

                // è¨ˆç®—çç›ƒæ•¸æ“š
                const gold = data.winCount || 0;
                const silver = data.secCount || 0;
                const bronze = data.trdCount || 0;
                const totalPodiums = gold + silver + bronze;

                // å»ºç«‹å½ˆçª—å…§å®¹ HTML
                let html = `
            <div style="background:#fff; border-radius:16px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.05); margin-bottom:24px; border:1px solid rgba(0,0,0,0.05);">
                <h2 style="margin:0 0 20px 0; font-size:22px; color:#1d1d1f;">å¸³è™Ÿ (ID)ï¼š${data.username}</h2>
                
                <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:20px;">
                    <div style="flex:1; min-width:100px;">
                        <div style="font-size:13px; color:#8e8e93; margin-bottom:4px;">ç”Ÿæ¶¯ç¸½ç©åˆ†</div>
                        <div style="font-size:28px; font-weight:700; color:#1d1d1f;">${data.totalScore.toLocaleString()}</div>
                    </div>
                    <div style="flex:1; min-width:100px;">
                        <div style="font-size:13px; color:#8e8e93; margin-bottom:4px;">ç¸½åƒè³½æ¬¡æ•¸</div>
                        <div style="font-size:28px; font-weight:700; color:#1d1d1f;">${data.raceCount}</div>
                    </div>
                     <div style="flex:1; min-width:100px;">
                        <div style="font-size:13px; color:#8e8e93; margin-bottom:4px;">åˆ†ç«™å† è»</div>
                        <div style="font-size:28px; font-weight:700; color:#1d1d1f;">${gold}</div>
                    </div>
                </div>

                <div style="margin-top:20px; padding-top:20px; border-top:1px solid #f5f5f7; display:flex; justify-content:space-between; align-items:center;">
                     <div>
                        <div style="font-size:13px; color:#8e8e93;">ä¸Šçå°æ¬¡æ•¸</div>
                        <div style="font-size:20px; font-weight:600; color:#1d1d1f;">${totalPodiums}</div>
                    </div>
                    <div style="text-align:right;">
                         <div style="font-size:13px; color:#8e8e93; margin-bottom:4px;">é‡‘ / éŠ€ / éŠ…ç›ƒ</div>
                         <div style="font-size:16px; font-weight:500;">ğŸ¥‡ ${gold} &nbsp; ğŸ¥ˆ ${silver} &nbsp; ğŸ¥‰ ${bronze}</div>
                    </div>
                </div>
            </div>

            <h3 style="margin-bottom:12px; font-size:17px; font-weight:600;">æœ€è¿‘åå ´è³½é“æˆç¸¾</h3>
            <div style="overflow-x:auto; border-radius:12px; border:1px solid rgba(0,0,0,0.08);">
                <table class="small-table" style="width:100%; margin:0;">
                    <thead style="background:#f2f2f7;">
                        <tr>
                            <th style="padding:10px;">æ—¥æœŸ</th>
                            <th style="padding:10px;">è³½é“</th>
                            <th style="padding:10px;">æ™‚é–“</th>
                            <th style="padding:10px;">ç©åˆ†</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

                if (data.recentRecords && data.recentRecords.length > 0) {
                    data.recentRecords.forEach(rec => {
                        html += `
                    <tr>
                        <td style="color:#555;">${rec.date || '-'}</td>
                        <td style="font-weight:500;">${rec.trackName}</td>
                        <td style="font-family:monospace;">${rec.bestTime}</td>
                        <td>${rec.points}</td>
                    </tr>
                `;
                    });
                } else {
                    html += `<tr><td colspan="4" style="padding:20px; color:#888;">å°šç„¡åƒè³½ç´€éŒ„</td></tr>`;
                }

                html += `
                    </tbody>
                </table>
            </div>
        `;
                content.innerHTML = html;
            });
        }

        // é—œé–‰æŒ‰éˆ•äº‹ä»¶
        document.getElementById("player-modal-close").addEventListener("click", () => {
            document.getElementById("player-modal").classList.remove("show");
            document.getElementById("player-modal-overlay").classList.remove("show");
        });
        document.getElementById("player-modal-overlay").addEventListener("click", () => {
            document.getElementById("player-modal").classList.remove("show");
            document.getElementById("player-modal-overlay").classList.remove("show");
        });
    </script>
</body>

</html>