<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>LEADERBOARD</title>
    <link rel="stylesheet" href="style.css">
    <script src="api.js"></script>
    <style>
        /* --- è³½é“å¡ç‰‡æ¨£å¼ --- */
        .track-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }
        .track-card {
            background: #fff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .track-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.12);
        }
        .track-card-img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: #f0f0f0;
        }
        .track-card-body {
            padding: 16px;
        }
        .track-card-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 4px 0;
            color: #1d1d1f;
        }

        /* --- ç¯©é¸å·¥å…·åˆ—æ¨£å¼ (å¡«æ»¿å¯¬åº¦) --- */
        .filter-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            background: #fff;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin-top: 20px;
            align-items: flex-end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1; /* â˜… é—œéµï¼šè®“æ¯å€‹è¼¸å…¥æ¡†å¹³å‡åˆ†é…å¯¬åº¦ */
            min-width: 200px;
        }
        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-left: 2px;
        }
        .filter-input {
            padding: 10px 12px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 14px;
            width: 100%; /* å¡«æ»¿å®¹å™¨ */
        }
        
        /* --- 1. å„€è¡¨æ¿ (Dashboard) --- */
        .dashboard-container {
            background: #fff;
            border-radius: 18px;
            padding: 24px;
            
            /* å¡ç‰‡æœ¬èº«åœ¨é é¢ç½®ä¸­ */
            margin: 20px auto; 
            max-width: 900px;
            
            /* â˜… é—œéµè¨­å®šï¼šå…§å®¹æ’ç‰ˆ â˜… */
            display: flex;
            flex-direction: row;     /* å·¦åœ–å³æ–‡ */
            align-items: center;     /* å‚ç›´ç½®ä¸­ (è®“æ–‡å­—å€å¡Šä¸Šä¸‹å±…ä¸­) */
            justify-content: center; /* â˜… æ°´å¹³ç½®ä¸­ (è®“åœ–+æ–‡çš„çµ„åˆåœ¨å¡ç‰‡æ­£ä¸­é–“) â˜… */
            text-align: left;        /* æ–‡å­—å…§å®¹é å·¦å°é½Š (æ¯”è¼ƒæ•´é½Š) */
            gap: 40px;               /* æ‹‰é–‹åœ–ç‰‡èˆ‡æ–‡å­—çš„é–“è·ï¼Œæ¯”è¼ƒå¤§æ°£ */
            
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.04);
        }

        /* åœ–ç‰‡æ¨£å¼ */
        .dash-img {
            width: 320px;
            height: 180px;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            flex-shrink: 0; /* ç¦æ­¢åœ–ç‰‡è¢«å£“ç¸® */
        }

        /* Final ç‹€æ…‹å°ˆç”¨ï¼šç„¡æ¡†ã€ç„¡é™°å½±ã€é€æ˜åº• */
        .dash-img-final {
            box-shadow: none !important;
            background: transparent !important;
            border-radius: 0 !important;
            object-fit: contain !important;
        }

        /* æ–‡å­—å€å¡Šï¼šè®“å®ƒä¸è¦å¤ªå¯¬ï¼Œä¿æŒç·Šæ¹Š */
        .dash-info {
            flex: 0 1 auto; /* å½ˆæ€§èª¿æ•´å¯¬åº¦ï¼Œä½†ä¸å¼·è¿«æ’æ»¿ */
            min-width: 300px;
        }
        .dash-badge {
            display: inline-block;
            background: #000;
            color: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .dash-badge.final { background: #ff3b30; } /* ç´…è‰² Final */
        
        .dash-title {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 8px 0;
            color: #1d1d1f;
        }
        .dash-meta {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
            font-weight: 500;
        }
        .dash-btn {
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dash-btn:hover { background: #005bb5; transform: scale(1.02); }
        .dash-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        
        /* å³æ™‚æœå°‹æ¡†æ¨£å¼ */
        .instant-search {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d1d6;
            border-radius: 10px;
            font-size: 15px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>');
            background-repeat: no-repeat;
            background-position: 10px center;
            padding-left: 36px; /* ç•™ä½ç½®çµ¦ icon */
        }
        
        @media (max-width: 768px) {
            .dashboard-container { flex-direction: column; text-align: center; }
            .dash-img { width: 100%; height: auto; }
            .filter-group { min-width: 100%; }
        }
        /* --- 2. è³½é“è©³æƒ…é ­éƒ¨ --- */
        .track-detail-header {
            background: #fff;
            border-radius: 16px;
            padding: 30px; /* åŠ å¤§å…§è· */
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);

            /* â˜… é—œéµè¨­å®šï¼šå…§å®¹æ’ç‰ˆ â˜… */
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center; /* â˜… æ°´å¹³ç½®ä¸­ â˜… */
            text-align: left;
            gap: 40px;
        }

        /* è³½é“è©³æƒ…åœ–ç‰‡ */
        .track-header-img {
            width: 360px; /* é€™è£¡åœ–ç‰‡å¯ä»¥ç¨å¾®å¤§ä¸€é» */
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        /* --- RWD: æ‰‹æ©Ÿç‰ˆè‡ªå‹•è®Šå›å‚ç›´æ’åˆ— --- */
        @media (max-width: 768px) {
            .dashboard-container, 
            .track-detail-header {
                flex-direction: column; /* æ”¹ç‚ºå‚ç›´ */
                text-align: center;     /* æ–‡å­—æ”¹ç‚ºç½®ä¸­ */
                padding: 20px;
                gap: 20px;
            }
            .dash-img, 
            .track-header-img {
                width: 100%;
                max-width: 100%;
                height: auto;
            }
            .dash-info {
                min-width: auto;
                width: 100%;
            }
        }
        /* --- å¹´ä»½é¸å–®å®¹å™¨ (åŒ…å«ç®­é ­) --- */
        .year-tabs-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            max-width: 960px; /* ç¨å¾®åŠ å¯¬ä»¥å®¹ç´ç®­é ­ */
            margin: 30px auto;
            padding: 0 10px;
        }

        /* éš±è—åŸæœ¬çš„ marginï¼Œæ”¹ç”± wrapper æ§åˆ¶ */
        .year-tabs {
            margin: 0; 
            flex: 1; /* å¡«æ»¿ä¸­é–“ç©ºé–“ */
            scroll-behavior: smooth; /* è®“ JS æ»‘å‹•æ™‚æœ‰å¹³æ»‘æ•ˆæœ */
        }

        /* å·¦å³ç®­é ­æŒ‰éˆ•æ¨£å¼ */
        .tab-arrow {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
            background: #fff;
            color: #333;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0; /* é˜²æ­¢æŒ‰éˆ•è¢«å£“ç¸® */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .tab-arrow:hover {
            background: #f5f5f7;
            transform: scale(1.1);
        }

        .tab-arrow:active {
            background: #e5e5ea;
            transform: scale(0.95);
        }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="header-inner">
            <div class="header-left">
                <nav class="header-nav">
                    <a href="home.html" class="nav-link">HOME</a>
                    <a href="leaderboard.html" class="nav-link nav-link-active">LEADERBOARD</a>
                    <a href="trade.html" class="nav-link">SHOP</a>
                    <a href="schedule.html" class="nav-link">SCHEDULE</a>
                </nav>
            </div>
            <div class="header-right">
                <div class="profile-icon" id="nav-profile-icon"></div>
            </div>
        </div>
    </header>

    <div class="app">
        <div class="top-bar">
            <h1>LEADERBOARD</h1>
        </div>

        <div class="card-container">
            <div class="card" id="card-score">
                <h2>Leaderboard</h2>
                <p>Season Ranking</p>
            </div>
            <div class="card" id="card-track">
                <h2>Track Records</h2>
                <p>Fastest Records</p>
            </div>
        </div>

        <div class="year-tabs-wrapper" style="display: none;">
            <button id="tab-prev" class="tab-arrow">â€¹</button>
            <div id="year-tabs" class="year-tabs"></div>
            <button id="tab-next" class="tab-arrow">â€º</button>
        </div>
        
        <section id="score-section" style="display:none;">
            
            <div id="race-dashboard" class="dashboard-container" style="display:none;">
                <img id="dash-img" src="" class="dash-img">
                
                <div class="dash-info">
                    <span id="dash-badge" class="dash-badge">NEXT RACE</span>
                    <h2 id="dash-track-name" class="dash-title">--</h2>
                    <div id="dash-meta" class="dash-meta">Round -- | Date: --</div>
                    <button id="dash-btn" class="dash-btn">Simulate</button>
                    <p id="dash-msg" style="margin-top:10px; color:green; font-weight:500;"></p>
                </div>
            </div>
            <div class="section-row" style="margin-bottom: 15px;">
                <div class="panel" style="flex:1;">
                    <input type="text" id="score-search-input" class="instant-search" placeholder="æœå°‹ç©å®¶...">
                </div>
            </div>

            <table id="score-table">
                <colgroup>
                    <col style="width:10%;">
                    <col style="width:25%;">
                    <col style="width:15%;">
                    <col style="width:15%;">
                    <col style="width:15%;">
                    <col style="width:20%;">
                </colgroup>
                <thead>
                    <tr>
                        <th>åæ¬¡</th>
                        <th>å¸³è™Ÿ</th>
                        <th>åˆ†ç«™å† è»</th>
                        <th>é ’çå°</th>
                        <th>å®Œè³½</th>
                        <th>ç©åˆ†</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="track-section" style="display:none; margin-top: 30px;">
            
            <div id="track-list-view">
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                    <input type="text" id="track-list-search" class="instant-search" style="flex:1" placeholder="æœå°‹è³½é“...">
                </div>
                
                <div id="track-grid-container" class="track-grid"></div>
            </div>

            <div id="track-detail-view" style="display:none;">
                <button id="back-to-tracks" style="margin-bottom:15px; background:#e5e5ea; border:none; padding:8px 16px; border-radius:20px; font-weight:600; cursor:pointer;">â† è¿”å›è³½é“åˆ—è¡¨</button>
                
                <div class="track-detail-header">
                    <img id="detail-track-img" src="" class="track-header-img">
                    
                    <div>
                        <h2 id="detail-track-name" style="margin:0 0 8px 0; font-size:32px; font-weight:700;">--</h2>
                        <p style="color:#666; margin:0; font-size: 16px;">
                            å–®åœˆé•·åº¦: <span id="detail-track-length" style="font-weight:bold; color:#1d1d1f;">--</span>
                        </p>
                    </div>
                </div>

                <div class="filter-toolbar">
                    <div class="filter-group" style="flex:0 0 150px; min-width:auto;">

                        <select id="filter-year" class="filter-input">
                            <option value="all">All Time</option>
                        </select>
                    </div>
                    <div class="filter-group">

                        <input type="text" id="filter-player" class="filter-input" placeholder="æœå°‹ç©å®¶...">
                    </div>
                    <div class="filter-group">
 
                        <input type="text" id="filter-car" class="filter-input" placeholder="æœå°‹è»Šæ¬¾...">
                    </div>
                </div>

                <table id="track-table" style="margin-top: 20px;">
                    <colgroup>
                        <col style="width:10%;">
                        <col style="width:20%;">
                        <col style="width:25%;">
                        <col style="width:20%;">
                        <col style="width:25%;">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>åæ¬¡</th>
                            <th>å¸³è™Ÿ</th>
                            <th>è»Šè¼›</th>
                            <th>æ™‚é–“</th>
                            <th>æ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div> </section>

        <div id="player-modal-overlay" class="modal-overlay"></div>
        <div id="player-modal" class="modal">
            <div class="modal-header">
                <h3>ç©å®¶è³‡æ–™</h3>
                <button id="player-modal-close" class="modal-close">Ã—</button>
            </div>
            <div id="player-modal-content" class="modal-content"></div>
        </div>
    </div>

    <script>
        // --- åˆå§‹åŒ– ---
        const playerId = localStorage.getItem("playerId");
        if (!playerId) window.location.href = "index.html";

        const navIcon = document.getElementById("nav-profile-icon");
        if (navIcon) {
            const username = localStorage.getItem("username") || "ä½ ";
            navIcon.textContent = username.charAt(0).toUpperCase();
            navIcon.addEventListener("click", () => window.location.href = "profile.html");
        }

        // é é¢å…ƒç´ 
        const scoreSection = document.getElementById("score-section");
        const trackSection = document.getElementById("track-section");
        const yearTabsContainer = document.getElementById("year-tabs");
        const raceDashboard = document.getElementById("race-dashboard");
        // æ–°å¢ï¼šå¹´ä»½é¸å–®çš„å¤–æ¡† (æ§åˆ¶ç®­é ­é¡¯ç¤ºç”¨)
        const yearTabsWrapper = document.querySelector(".year-tabs-wrapper");

        // ç‹€æ…‹è®Šæ•¸
        let currentYear = null;
        let selectedTrackName = null;
        
        // â˜… è³‡æ–™ç·©å­˜ (ç”¨æ–¼å‰ç«¯å³æ™‚æœå°‹)
        let allScoreData = []; // å­˜ç©åˆ†æ¦œå®Œæ•´è³‡æ–™
        let allTracksData = []; // å­˜æ‰€æœ‰è³½é“è³‡æ–™

        // åˆ‡æ›æ¨¡å¼
        document.getElementById("card-score").addEventListener("click", () => switchMode('score'));
        document.getElementById("card-track").addEventListener("click", () => switchMode('track'));

        function switchMode(mode) {
            // 1. å…ˆã€Œå…¨éƒ¨éš±è—ã€ï¼Œé˜²æ­¢æ®˜ç•™
            scoreSection.style.display = "none";
            trackSection.style.display = "none";
            
            // 2. åˆ¤æ–·è¦é–‹å“ªä¸€å€‹
            if (mode === 'score') {
                // --- é¡¯ç¤ºï¼šç©åˆ†æ¦œ ---
                scoreSection.style.display = "block";
                
                // é¡¯ç¤ºå¹´ä»½ç®­é ­
                if(yearTabsWrapper) yearTabsWrapper.style.display = "flex";

                // â˜… é—œéµä¿®å¾©ï¼šåˆ‡æ›å›ä¾†æ™‚ï¼Œè¦æª¢æŸ¥æ˜¯å¦æ‡‰è©²é¡¯ç¤ºå„€è¡¨æ¿
                // å¦‚æœç›®å‰é¸çš„ä¸æ˜¯ã€Œç”Ÿæ¶¯ç¸½è¨ˆ(all)ã€ï¼Œä¸”å·²ç¶“æœ‰é¸å¹´ä»½ï¼Œå°±è¦æŠŠå„€è¡¨æ¿é–‹å›ä¾†
                if (currentYear && currentYear !== 'all') {
                    raceDashboard.style.display = "flex";
                } else {
                    // å¦‚æœé‚„æ²’åˆå§‹åŒ–ï¼Œé€™è¡Œæ²’å½±éŸ¿ï¼›å¦‚æœæ˜¯ allï¼Œå‰‡ä¿æŒéš±è—
                    raceDashboard.style.display = "none"; 
                }

                if (!currentYear) initYearTabs();

            } else {
                // --- é¡¯ç¤ºï¼šè³½é“ç´€éŒ„ ---
                trackSection.style.display = "block";
                
                // éš±è—å¹´ä»½ç®­é ­
                if(yearTabsWrapper) yearTabsWrapper.style.display = "none";
                
                // éš±è—å„€è¡¨æ¿ (è³½é“æ¦œä¸éœ€è¦)
                raceDashboard.style.display = "none";

                // â˜… é—œéµä¿®å¾©ï¼šå¼·åˆ¶å›åˆ°ã€Œè³½é“åˆ—è¡¨ã€ï¼Œé˜²æ­¢å¡åœ¨ã€Œè³½é“è©³æƒ…é ã€
                document.getElementById("track-list-view").style.display = "block";
                document.getElementById("track-detail-view").style.display = "none";

                loadTrackList(); 
                initFilterYearOptions();
            }
        }

    // ==========================================
        // 1. ç©åˆ†æ’è¡Œæ¦œé‚è¼¯ (å¹´ä»½æ’åº + ç®­é ­æ»‘å‹•)
        // ==========================================
        // ç”¨ä¾†æš«å­˜å…¨åŸŸè³½äº‹è³‡æ–™
        let cachedGlobalNextRace = null;

        function initYearTabs() {
            // å¹³è¡ŒåŸ·è¡Œï¼šæŠ“å¹´ä»½ + æŠ“å…¨åŸŸè³½äº‹
            Promise.all([
                apiGetYears(),
                apiGetGlobalNextRace()
            ]).then(([years, nextRaceData]) => {
                
                // â˜… æŠŠæŠ“åˆ°çš„è³‡æ–™å­˜èµ·ä¾†ï¼
                cachedGlobalNextRace = nextRaceData;

                yearTabsContainer.innerHTML = "";
                
                if(Array.isArray(years)) {
                    years.sort((a, b) => a - b);
                    years.push("all"); 
                } else {
                    years = [2024, "all"]; 
                }

                // æ±ºå®šé è¨­é¸ä¸­å“ªä¸€å¹´
                // å„ªå…ˆé–å®šã€Œå…¨åŸŸè³½äº‹ã€çš„å¹´ä»½
                let targetYear = 2024;
                if (years.length >= 2) targetYear = years[years.length - 2]; 

                if (nextRaceData && nextRaceData.status === "Pending") {
                    const pendingYear = nextRaceData.seasonYear || nextRaceData.SeasonYear;
                    if (years.includes(pendingYear)) {
                        targetYear = pendingYear;
                    }
                }
                
                if (!currentYear) currentYear = targetYear;

                // æ¸²æŸ“ Tab
                years.forEach(y => {
                    const div = document.createElement("div");
                    div.className = "year-tab";
                    div.innerText = (y === 'all') ? "ç”Ÿæ¶¯ç¸½è¨ˆ" : y;
                    
                    if (y == currentYear) div.classList.add("active");
                    
                    div.addEventListener("click", () => {
                        document.querySelectorAll(".year-tab").forEach(t => t.classList.remove("active"));
                        div.classList.add("active");
                        div.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });

                        currentYear = y;
                        loadScoreLeaderboard(y);
                        
                        // â˜… åˆ‡æ›å¹´ä»½æ™‚ï¼Œæ°¸é å‚³å…¥ã€Œå­˜èµ·ä¾†çš„å…¨åŸŸè³‡æ–™ã€
                        loadDashboard(cachedGlobalNextRace); 
                    });
                    yearTabsContainer.appendChild(div);
                });
                
                // ç¶å®šç®­é ­
                const btnPrev = document.getElementById("tab-prev");
                const btnNext = document.getElementById("tab-next");
                if(btnPrev) btnPrev.onclick = () => yearTabsContainer.scrollBy({ left: -150, behavior: 'smooth' });
                if(btnNext) btnNext.onclick = () => yearTabsContainer.scrollBy({ left: 150, behavior: 'smooth' });

                // åˆå§‹è¼‰å…¥
                loadScoreLeaderboard(currentYear);
                loadDashboard(cachedGlobalNextRace); 

            }).catch(err => {
                console.warn("Init Error:", err);
            });
        }

        // è¼‰å…¥ç©åˆ†æ¦œ (ä¸¦å­˜å…¥ç·©å­˜)
        function loadScoreLeaderboard(year) {
            const tbody = document.querySelector("#score-table tbody");
            tbody.innerHTML = `<tr><td colspan="6">è¼‰å…¥ä¸­...</td></tr>`;
            
            apiGetLeaderboardByYear(year).then(data => {
                allScoreData = data || []; // â˜… å­˜èµ·ä¾†
                renderScoreTable(allScoreData); // æ¸²æŸ“
            });
        }

        // æ¸²æŸ“è¡¨æ ¼ (æ”¯æ´ç¯©é¸)
        function renderScoreTable(data) {
            const tbody = document.querySelector("#score-table tbody");
            tbody.innerHTML = "";
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6">ç„¡è³‡æ–™</td></tr>`;
                return;
            }
            data.forEach(row => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${row.rank}</td>
                    <td style="color:#0071e3; cursor:pointer; font-weight:500;" onclick="openPlayerModal('${row.username}')">${row.username}</td>
                    <td>${row.winCount}</td>
                    <td>${row.podiumCount}</td>
                    <td>${row.raceCount}</td>
                    <td>${row.score}</td>`;
                tbody.appendChild(tr);
            });
        }

        // â˜… å³æ™‚æœå°‹ï¼šç©åˆ†æ¦œ
        document.getElementById("score-search-input").addEventListener("input", (e) => {
            const keyword = e.target.value.toLowerCase();
            // åªä¿ç•™ç¬¦åˆé—œéµå­—çš„äºº (éæ¿¾)
            const filtered = allScoreData.filter(d => d.username.toLowerCase().includes(keyword));
            renderScoreTable(filtered);
        });

       // ==========================================
        // 2. å„€è¡¨æ¿èˆ‡æ¨¡æ“¬é‚è¼¯ (æ–°å¢è³½å­£é¡¯ç¤º + æ—¥æœŸç°¡åŒ–)
        // ==========================================
        // ==========================================
        // 2. å„€è¡¨æ¿é‚è¼¯ (ç´”é¡¯ç¤ºæ¨¡å¼ + Finalå»èƒŒ)
        // ==========================================
        function loadDashboard(data) {
            const dashboard = document.getElementById("race-dashboard");
            
            // â˜… ä¿®æ”¹ï¼šæ°¸é é¡¯ç¤ºå„€è¡¨æ¿ (å³ä½¿æ˜¯ç”Ÿæ¶¯æ¨¡å¼)
            dashboard.style.display = "flex"; 

            const elBadge = document.getElementById("dash-badge");
            const elTitle = document.getElementById("dash-track-name");
            const elMeta = document.getElementById("dash-meta");
            const elImg = document.getElementById("dash-img");
            const btn = document.getElementById("dash-btn");
            const msg = document.getElementById("dash-msg");
            
            msg.innerText = "";

            // â˜… æ­¥é©Ÿ 1ï¼šå…ˆç§»é™¤ Final ç‰¹æ®Šæ¨£å¼ (æ¢å¾©é è¨­æœ‰æ¡†)
            elImg.classList.remove("dash-img-final");
            
            // å¦‚æœé‚„æ²’æ‹¿åˆ°è³‡æ–™ï¼Œé¡¯ç¤º Loading
            if(!data) {
                elTitle.innerText = "è¼‰å…¥ä¸­...";
                btn.disabled = true;
                btn.innerText = "è®€å–ä¸­...";
                elImg.src = ""; 
                return;
            }

            // --- é–‹å§‹æ¸²æŸ“ ---
            btn.disabled = false;
            const status = data.status || data.Status;
            
            if (status === "Finished") {
                // â˜… æ­¥é©Ÿ 2ï¼šå¦‚æœæ˜¯ Finishedï¼ŒåŠ ä¸Šå»èƒŒæ¨£å¼
                elImg.classList.add("dash-img-final");

                elBadge.className = "dash-badge";
                elBadge.innerText = "SEASON FINISHED";
                elMeta.innerText = `NEXT ${data.nextSeasonYear || data.NextSeasonYear}`;
                elImg.src = "images/trophy-default.png"; 
                
                btn.innerText = "New Season";
                btn.onclick = () => alert(`è«‹è¯ç¹«ç®¡ç†å“¡æ›´æ–°è³½ç¨‹ã€‚`);

            } else if (status === "Pending") {
                // â˜… æ­¥é©Ÿ 3ï¼šå¦‚æœæ˜¯ Pendingï¼Œç¢ºä¿ç§»é™¤æ¨£å¼
                elImg.classList.remove("dash-img-final");

                const trackName = data.trackName || data.TrackName || "--";
                const round = data.round || data.Round;
                const totalRounds = data.totalRounds || data.TotalRounds;
                const trackUrl = data.trackUrl || data.TrackUrl || 'img/track-default.jpg';
                const isFinal = data.isFinal || data.IsFinal;
                const raceYear = data.seasonYear || data.SeasonYear; 
                
                // æ—¥æœŸæ ¼å¼åŒ–
                let dateStr = "å¾…å®š";
                const rawDate = data.raceDate || data.RaceDate;
                if (rawDate) {
                    const d = new Date(rawDate);
                    if(!isNaN(d.getTime())) {
                        dateStr = `${d.getMonth() + 1}/${d.getDate()}`;
                    } else {
                        const parts = rawDate.split('-');
                        if(parts.length >= 3) dateStr = `${parseInt(parts[1])}/${parseInt(parts[2])}`;
                    }
                }

                elTitle.innerText = trackName;
                elMeta.innerHTML = `
                    <span style="color:#0071e3; font-weight:bold;">${raceYear}</span> &nbsp;â€¢&nbsp; 
                    Round ${round} &nbsp;â€¢&nbsp; 
                    ${dateStr}
                `;
                elImg.src = trackUrl;
                
                if (isFinal) {
                    elBadge.innerText = "FINAL RACE";
                    elBadge.className = "dash-badge final";
                } else {
                    elBadge.innerText = "NEXT RACE";
                    elBadge.className = "dash-badge";
                }

                btn.innerText = "Simulate";
                btn.onclick = () => {
                    if(!confirm(`ç¢ºå®šè¦é–‹å§‹æ¨¡æ“¬ ${trackName} çš„æ¯”è³½å—ï¼Ÿ`)) return;
                    btn.disabled = true;
                    btn.innerText = "æ¯”è³½é€²è¡Œä¸­...";
                    
                    // æ¨¡æ“¬è©²å¹´ä»½çš„æ¯”è³½
                    apiSimulateRace(raceYear).then(res => {
                        if(res.ok) {
                            msg.innerText = "æ¯”è³½å®Œæˆï¼æ’è¡Œæ¦œå·²æ›´æ–°ã€‚";
                            // â˜… æ¨¡æ“¬å®Œç•¢å¾Œï¼Œé‡æ–°è·‘ä¸€æ¬¡åˆå§‹åŒ–ï¼ŒæŠ“å–æ–°çš„ä¸‹ä¸€å ´
                            initYearTabs(); 
                        } else {
                            const errMsg = (res.data && (res.data.message || res.data.Message)) || "æœªçŸ¥éŒ¯èª¤";
                            alert("æ¨¡æ“¬å¤±æ•—: " + errMsg);
                            btn.disabled = false;
                            btn.innerText = "Simulate";
                        }
                    });
                };
            } else {
                elBadge.innerText = "ERROR";
                elTitle.innerText = "ç‹€æ…‹ç•°å¸¸";
                btn.disabled = true;
            }
        }

        // ==========================================
        // 2. è³½é“ç´€éŒ„é‚è¼¯
        // ==========================================
        
        const trackListView = document.getElementById("track-list-view");
        const trackDetailView = document.getElementById("track-detail-view");
        const trackGrid = document.getElementById("track-grid-container");

        // è¼‰å…¥è³½é“åˆ—è¡¨ (å­˜å…¥ç·©å­˜)
       function loadTrackList() {
            trackListView.style.display = "block";
            trackDetailView.style.display = "none";
            trackGrid.innerHTML = "è¼‰å…¥ä¸­...";

            apiGetTracks().then(tracks => {
                allTracksData = tracks || []; 
                renderTrackGrid(allTracksData);

                // â˜… æ–°å¢ï¼šæª¢æŸ¥ç¶²å€æ˜¯å¦æœ‰æŒ‡å®šè³½é“ (Deep Linking)
                const params = new URLSearchParams(window.location.search);
                const targetName = params.get('target');
                
                // å¦‚æœæœ‰æŒ‡å®š targetï¼Œä¸”è©²è³½é“å­˜åœ¨æ–¼è³‡æ–™ä¸­
                if (targetName) {
                    const targetTrack = allTracksData.find(t => t.name === targetName);
                    if (targetTrack) {
                        // è‡ªå‹•é»æ“Šé€²å…¥è©³æƒ…
                        openTrackDetail(targetTrack);
                        
                        // (é¸ç”¨) æ¸…é™¤ç¶²å€åƒæ•¸ï¼Œè®“ä½¿ç”¨è€…é‡æ–°æ•´ç†æ™‚å›åˆ°åˆ—è¡¨ï¼Œé«”é©—è¼ƒå¥½
                        window.history.replaceState({}, document.title, "leaderboard.html");
                    }
                }
            });
        }

        // æ¸²æŸ“ Grid
        function renderTrackGrid(tracks) {
            trackGrid.innerHTML = "";
            if(tracks.length === 0) {
                trackGrid.innerHTML = "<p>ç„¡è³½é“è³‡æ–™</p>";
                return;
            }

            tracks.forEach(track => {
                const card = document.createElement("div");
                card.className = "track-card";
                card.onclick = () => openTrackDetail(track);
                
                const imgSrc = track.imageUrl || 'img/track-default.jpg'; 
                card.innerHTML = `
                    <img src="${imgSrc}" class="track-card-img" onerror="this.src='img/track-default.jpg'">
                    <div class="track-card-body">
                        <h3 class="track-card-title">${track.name}</h3>
                        <div style="font-size:13px; color:#666;">${track.length || '?'} KM</div>
                    </div>
                `;
                trackGrid.appendChild(card);
            });
        }

        // â˜… å³æ™‚æœå°‹ï¼šè³½é“åˆ—è¡¨
        document.getElementById("track-list-search").addEventListener("input", (e) => {
            const val = e.target.value.toLowerCase();
            const filtered = allTracksData.filter(t => t.name.toLowerCase().includes(val));
            renderTrackGrid(filtered);
        });

        // é€²å…¥è©³æƒ…
        function openTrackDetail(track) {
            selectedTrackName = track.name;
            trackListView.style.display = "none";
            trackDetailView.style.display = "block";
            
            document.getElementById("detail-track-name").innerText = track.name;
            document.getElementById("detail-track-length").innerText = (track.length || '?') + "KM";
            document.getElementById("detail-track-img").src = track.imageUrl || 'img/track-default.jpg';
            
            // é‡ç½®è¼¸å…¥æ¡†
            document.getElementById("filter-year").value = "all";
            document.getElementById("filter-player").value = "";
            document.getElementById("filter-car").value = "";

            loadTrackTable();
        }

        // è¼‰å…¥ç´€éŒ„è¡¨æ ¼ (å³æ™‚æŸ¥è©¢)
        function loadTrackTable() {
            if (!selectedTrackName) return;
            const tbody = document.querySelector("#track-table tbody");
            
            // ç”±æ–¼å³æ™‚æœå°‹é »ç‡é«˜ï¼Œé€™è£¡å¯ä»¥è€ƒæ…® Debounceï¼Œä½†å¦‚æœè³‡æ–™é‡ä¸å¤§ç›´æ¥å‘¼å«ä¹Ÿè¡Œ
            // é€™è£¡ç¤ºç¯„ç›´æ¥å‘¼å« API
            const yearVal = document.getElementById("filter-year").value;
            const playerVal = document.getElementById("filter-player").value.trim();
            const carVal = document.getElementById("filter-car").value.trim();

            apiGetTrackLeaderboard(selectedTrackName, yearVal, playerVal, carVal).then(data => {
                tbody.innerHTML = "";
                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„</td></tr>`;
                    return;
                }
                data.forEach(row => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${row.rank}</td>
                        <td style="color:#0071e3; cursor:pointer; font-weight:500;" onclick="openPlayerModal('${row.username}')">${row.username}</td>
                        <td>${row.carName || '-'}</td>
                        <td style="font-family:monospace; font-weight:bold;">${row.bestTime}</td>
                        <td>${row.date || '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        // â˜… å³æ™‚æœå°‹ï¼šè³½é“ç´€éŒ„çš„ä¸‰å€‹ç¯©é¸å™¨
        // ç¶å®šäº‹ä»¶ï¼šåªè¦è¼¸å…¥è®Šå‹•ï¼Œå°±é‡æ–°æ’ˆå–è³‡æ–™
        const filters = ["filter-year", "filter-player", "filter-car"];
        filters.forEach(id => {
            document.getElementById(id).addEventListener("input", () => loadTrackTable());
        });

        // åˆå§‹åŒ–å¹´ä»½
        function initFilterYearOptions() {
            const sel = document.getElementById("filter-year");
            apiGetYears().then(years => {
                sel.innerHTML = `<option value="all">All Time</option>`;
                years.forEach(y => {
                    const opt = document.createElement("option");
                    opt.value = y;
                    opt.innerText = y;
                    sel.appendChild(opt);
                });
            });
        }
        
        document.getElementById("back-to-tracks").addEventListener("click", loadTrackList);

        // ç©å®¶å½ˆçª—ä¿æŒä¸è®Š
        function openPlayerModal(username) {
            const modal = document.getElementById("player-modal");
            const overlay = document.getElementById("player-modal-overlay");
            const content = document.getElementById("player-modal-content");
            
            content.innerHTML = '<div style="text-align:center; padding:30px; color:#888;">è³‡æ–™è®€å–ä¸­...</div>';
            modal.classList.add("show");
            overlay.classList.add("show");
            
            apiGetPlayerDetail(username).then(data => {
                if (!data) { 
                    content.innerHTML = '<div style="text-align:center; padding:20px;">æ‰¾ä¸åˆ°è©²ç©å®¶è³‡æ–™</div>'; 
                    return; 
                }

                const gold = data.seasonGold || 0;
                const silver = data.seasonSilver || 0;
                const bronze = data.seasonBronze || 0;
                // â˜… æ ¼å¼åŒ–è¨»å†Šæ—¥æœŸ
                const regDateText = data.regDate ? new Date(data.regDate).toLocaleDateString("zh-TW") : "-";

                let html = `
                    <div style="background:#fff; border-radius:16px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.05); margin-bottom:24px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h2 style="margin:0; font-size:28px;">${data.username}</h2>
                            <div style="text-align:right;">
                                <div style="font-size:12px; color:#888;">ç›®å‰æ’å</div>
                                <div style="font-size:20px; font-weight:800; color:#0071e3;">${data.currentRank}</div>
                            </div>
                        </div>
                        
                        <div style="font-size:24px; margin-bottom:20px; font-weight:700; text-align:center; background:#f9f9f9; padding:10px; border-radius:12px;">
                            ğŸ¥‡${gold} <span style="font-size:18px; color:#ddd; margin:0 5px;">|</span> 
                            ğŸ¥ˆ${silver} <span style="font-size:18px; color:#ddd; margin:0 5px;">|</span> 
                            ğŸ¥‰${bronze}
                        </div>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; border-top:1px solid #eee; padding-top:15px;">
                            
                            <div>
                                <div style="font-size:12px; color:#888;">ç”Ÿæ¶¯ç¸½ç©åˆ†</div>
                                <div style="font-size:18px; font-weight:600;">${data.totalScore.toLocaleString()}</div>
                            </div>
                            
                            <div>
                                <div style="font-size:12px; color:#888;">åˆ†ç«™å† è» (Wins)</div>
                                <div style="font-size:18px; font-weight:600;">${data.raceWins}</div>
                            </div>

                            <div>
                                <div style="font-size:12px; color:#888;">å®Œè³½æ¬¡æ•¸</div>
                                <div style="font-size:18px; font-weight:600;">${data.raceCount}</div>
                            </div>

                            <div>
                                <div style="font-size:12px; color:#888;">ä¸Šé ’çå° (Podiums)</div>
                                <div style="font-size:18px; font-weight:600;">${data.podiums}</div>
                            </div>
                        </div>

                        <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee; text-align:right; font-size:12px; color:#aaa;">
                            è¨»å†Šæ™‚é–“ï¼š${regDateText}
                        </div>
                    </div>

                    <h3 style="margin-bottom:10px;">æœ€è¿‘ 10 å ´è³½äº‹</h3>
                    <div style="max-height: 250px; overflow-y: auto;">
                        <table class="small-table" style="width:100%; border-collapse:collapse;">
                            <thead style="position:sticky; top:0; background:#fff;">
                                <tr style="border-bottom:2px solid #f5f5f7;">
                                    <th style="padding:8px; text-align:left; font-size:12px; color:#999;">æ—¥æœŸ</th>
                                    <th style="padding:8px; text-align:left; font-size:12px; color:#999;">è³½é“</th>
                                    <th style="padding:8px; text-align:right; font-size:12px; color:#999;">æˆç¸¾</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                if(data.recentRecords && data.recentRecords.length > 0) {
                    data.recentRecords.forEach(r => {
                        html += `
                            <tr style="border-bottom:1px solid #f9f9f9;">
                                <td style="padding:10px 8px; font-size:14px; color:#666;">${r.date}</td>
                                <td style="padding:10px 8px; font-weight:600;">
                                    <a href="leaderboard.html?mode=track&target=${encodeURIComponent(r.trackName)}" 
                                       style="color:#0071e3; text-decoration:none;">
                                       ${r.trackName}
                                    </a>
                                </td>
                                <td style="padding:10px 8px; text-align:right; font-family:monospace; font-size:14px;">${r.bestTime}</td>
                            </tr>`;
                    });
                } else {
                    html += `<tr><td colspan="3" style="text-align:center; padding:20px; color:#999;">å°šç„¡åƒè³½ç´€éŒ„</td></tr>`;
                }

                html += `</tbody></table></div>`;
                

                content.innerHTML = html;
            });
        }
        document.getElementById("player-modal-close").addEventListener("click", () => {
            document.getElementById("player-modal").classList.remove("show");
            document.getElementById("player-modal-overlay").classList.remove("show");
        });
        document.getElementById("player-modal-overlay").addEventListener("click", () => {
            document.getElementById("player-modal").classList.remove("show");
            document.getElementById("player-modal-overlay").classList.remove("show");
        });
document.getElementById("player-modal-overlay").addEventListener("click", () => {
            document.getElementById("player-modal").classList.remove("show");
            document.getElementById("player-modal-overlay").classList.remove("show");
        });

        // â˜… æ–°å¢ï¼šç¶²é è¼‰å…¥æ™‚ï¼Œæª¢æŸ¥ç¶²å€åƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('mode') === 'track') {
            // å¦‚æœç¶²å€æŒ‡å®š mode=trackï¼Œè‡ªå‹•åˆ‡æ›åˆ°è³½é“æ¦œ
            // switchMode æœƒå‘¼å« loadTrackListï¼Œç„¶å¾Œ loadTrackList æœƒè™•ç† target
            switchMode('track');
        }
    </script>
</body>
</html>