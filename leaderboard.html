<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>æ’è¡Œæ¦œ</title>
    <link rel="stylesheet" href="style.css">
    <script src="api.js"></script>
</head>

<body>
    <header class="site-header">
        <div class="header-inner">
            <!-- å·¦é‚Šï¼šlogo + å°è¦½é€£çµï¼Œå…¨é å·¦ -->
            <div class="header-left">
                <div class="header-logo">ï£¿ TC2 DB</div>
                <nav class="header-nav">
                    <a href="home.html" class="nav-link">é¦–é </a>
                    <a href="leaderboard.html" class="nav-link nav-link-active">æ’è¡Œæ¦œ</a>
                    <a href="trade.html" class="nav-link">äº¤æ˜“ä¸­å¿ƒ</a>
                </nav>
            </div>

            <!-- å³é‚Šï¼šprofile iconï¼ˆåªå‰©é€™ä¸€é¡†ï¼‰ -->
            <div class="header-right">
                <div class="profile-icon" id="nav-profile-icon"></div>
            </div>
        </div>
    </header>

    <div class="app">
        <div class="top-bar">
            <h1>æ’è¡Œæ¦œ</h1>
            <p id="next-race-info"></p>
        </div>

        <!-- å¡ç‰‡ï¼šå·¦ç©åˆ†æ¦œã€å³è³½é“ç´€éŒ„ -->
        <div class="card-container">
            <div class="card" id="card-score">
                <h2>ç©åˆ†æ’è¡Œæ¦œ</h2>
                <p>ä¾ç©å®¶å¹´åº¦ç¸½ç©åˆ†æ’åºï¼Œä¸¦å¯æŸ¥è©¢ç©å®¶åæ¬¡ã€‚</p>
            </div>

            <div class="card" id="card-track">
                <h2>è³½é“ç´€éŒ„</h2>
                <p>æŸ¥çœ‹å„è³½é“æ’è¡Œæ¦œï¼Œæˆ–æŸ¥è©¢ç‰¹å®šç©å®¶çš„è³½é“ç´€éŒ„ã€‚</p>
            </div>
        </div>

        <!-- ç©åˆ†æ’è¡Œæ¦œå€å¡Š -->
        <section id="score-section" style="display:none; margin-top:30px;">
            <h2>ç©åˆ†æ’è¡Œæ¦œ</h2>

            <div class="section-row">
                <div class="panel">
                    <div class="field-label">å¹´åº¦</div>
                    <select id="year-select"></select>
                </div>

                <div class="panel">
                    <div class="field-label">
                        æŸ¥è©¢ç©å®¶åæ¬¡ï¼ˆè¼¸å…¥å¸³è™Ÿï¼‰
                    </div>
                    <div class="inline-input">
                        <input type="text" id="rank-search-name">
                        <button id="rank-search-btn">æŸ¥è©¢</button>
                    </div>
                    <p id="rank-search-result" class="hint-text"></p>
                </div>
            </div>

            <table id="score-table">
                <thead>
                    <tr>
                        <th>åæ¬¡</th>
                        <th>å¸³è™Ÿ</th>
                        <th>è©²å¹´åº¦ç©åˆ†</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <!-- ç©å®¶è³‡æ–™å½ˆçª— -->
        <div id="player-modal-overlay" class="modal-overlay"></div>
        <div id="player-modal" class="modal">
            <div class="modal-header">
                <h3>ç©å®¶è³‡æ–™</h3>
                <button id="player-modal-close" class="modal-close">Ã—</button>
            </div>
            <div id="player-modal-content" class="modal-content"></div>
        </div>
        <!-- è³½é“ç´€éŒ„å€å¡Š -->
        <section id="track-section" style="display:none; margin-top:30px;">
            <h2>è³½é“ç´€éŒ„</h2>

            <div class="section-row">
                <div class="panel">
                    <div class="field-label">é¸æ“‡è³½é“</div>
                    <select id="track-select"></select>
                </div>

                <div class="panel">
                    <div class="field-label">
                        æŸ¥è©¢ç©å®¶çš„è³½é“ç´€éŒ„ï¼ˆè¼¸å…¥å¸³è™Ÿï¼ŒæŸ¥æ‰€æœ‰è³½é“ï¼‰
                    </div>
                    <div class="inline-input">
                        <input type="text" id="track-player-name">
                        <button id="track-player-btn">æŸ¥è©¢</button>
                    </div>
                </div>
            </div>

            <!-- é€™è£¡åŠ  colgroup å›ºå®šæ¬„å¯¬ -->
            <table id="track-table">
                <colgroup>
                    <col style="width:10%;"> <!-- åæ¬¡ -->
                    <col style="width:35%;"> <!-- å¸³è™Ÿ -->
                    <col style="width:35%;"> <!-- æœ€ä½³æ™‚é–“ -->
                    <col style="width:15%;"> <!-- ç©åˆ† -->
                </colgroup>
                <thead>
                    <tr>
                        <th>åæ¬¡</th>
                        <th>å¸³è™Ÿ</th>
                        <th>æœ€ä½³æ™‚é–“</th>
                        <th>ç©åˆ†</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <h4 style="margin-top:16px; margin-bottom:4px;">ç©å®¶å„è³½é“ç¸½è¦½</h4>

            <!-- ä¸‹é¢é€™å€‹ä¹ŸåŠ  colgroupï¼Œä¿æŒä¸€è‡´ -->
            <table id="track-player-table">
                <colgroup>
                    <col style="width:30%;"> <!-- è³½é“ -->
                    <col style="width:25%;"> <!-- å¸³è™Ÿ -->
                    <col style="width:15%;"> <!-- åæ¬¡ -->
                    <col style="width:15%;"> <!-- æœ€ä½³æ™‚é–“ -->
                    <col style="width:15%;"> <!-- ç©åˆ† -->
                </colgroup>
                <thead>
                    <tr>
                        <th>è³½é“</th>
                        <th>å¸³è™Ÿ</th>
                        <th>åæ¬¡</th>
                        <th>æœ€ä½³æ™‚é–“</th>
                        <th>ç©åˆ†</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </div>

    <script>
        // ---------- ç©å®¶è©³ç´°å½ˆçª— ----------
        const playerModalOverlay = document.getElementById("player-modal-overlay");
        const playerModal = document.getElementById("player-modal");
        const playerModalClose = document.getElementById("player-modal-close");
        const playerModalContent = document.getElementById("player-modal-content");

        playerModalClose.addEventListener("click", hidePlayerModal);
        playerModalOverlay.addEventListener("click", hidePlayerModal);

        // æ–°ç‰ˆï¼šå¤šå¸¶ rank / year é€²ä¾†ï¼ˆå¾ç©åˆ†è¡¨é‚£é‚Šä¸Ÿé€²ä¾†ï¼‰
        function showPlayerModal(username) {
            apiGetPlayerDetail(username).then(info => {
                if (!info) {
                    alert("æ‰¾ä¸åˆ°é€™ä½ç©å®¶çš„è³‡æ–™");
                    return;
                }

                // ç›´æ¥ç”¨å¾Œç«¯å¾ SEASON_POINTS ç®—å¥½çš„æ¬„ä½
                const raceCount = info.raceCount || 0;
                const winCount = info.winCount || 0;
                const secCount = info.secCount || 0;
                const trdCount = info.trdCount || 0;

                const goldCups = winCount;
                const silverCups = secCount;
                const bronzeCups = trdCount;
                const podiumCount = goldCups + silverCups + bronzeCups;

                let html = `
      <div style="margin-bottom:16px;padding:14px 16px;border-radius:16px;
                  background:#ffffff;border:1px solid rgba(0,0,0,0.06);">
        <div style="font-size:14px;margin-bottom:8px;">
          å¸³è™Ÿ (ID)ï¼š${info.username}
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:16px;">
          <div style="min-width:120px;">
            <div style="font-size:12px;color:#6e6e73;">ç”Ÿæ¶¯ç¸½ç©åˆ†</div>
            <div style="font-size:18px;font-weight:600;">
              ${info.totalScore ?? "-"}
            </div>
          </div>
<div style="min-width:120px;">
  <div style="font-size:12px;color:#6e6e73;">ç¸½åƒè³½æ¬¡æ•¸</div>
  <div style="font-size:18px;font-weight:600;">
    ${raceCount}
  </div>
</div>
<div style="min-width:140px;">
  <div style="font-size:12px;color:#6e6e73;">åˆ†ç«™å† è»æ¬¡æ•¸</div>
  <div style="font-size:18px;font-weight:600;">
    ${winCount}
  </div>
</div>
<div style="min-width:140px;">
  <div style="font-size:12px;color:#6e6e73;">ä¸Šçå°æ¬¡æ•¸</div>
  <div style="font-size:18px;font-weight:600;">
    ${podiumCount}
  </div>
</div>
<div style="min-width:160px;">
  <div style="font-size:12px;color:#6e6e73;">é‡‘ / éŠ€ / éŠ…ç›ƒ</div>
  <div style="font-size:18px;font-weight:600;">
    ğŸ¥‡${goldCups}ã€€ğŸ¥ˆ${silverCups}ã€€ğŸ¥‰${bronzeCups}
  </div>
</div>
          </div>
        </div>
      </div>
      <h4>æœ€è¿‘åå ´è³½é“æˆç¸¾</h4>
    `;

                if (!info.recentRecords || info.recentRecords.length === 0) {
                    html += "<p>å°šç„¡è³½é“æˆç¸¾ç´€éŒ„</p>";
                } else {
                    html += `
        <table class="small-table">
          <thead>
            <tr>
              <th>è³½é“</th><th>æ™‚é–“</th><th>ç©åˆ†</th>
            </tr>
          </thead>
          <tbody>
      `;
                    info.recentRecords.forEach(r => {
                        html += `
          <tr>
            <td>${r.trackName}</td>
            <td>${r.bestTime}</td>
            <td>${r.points}</td>
          </tr>
        `;
                    });
                    html += "</tbody></table>";
                }

                playerModalContent.innerHTML = html;
                playerModalOverlay.classList.add("show");
                playerModal.classList.add("show");
            });
        }

        function hidePlayerModal() {
            playerModalOverlay.classList.remove("show");
            playerModal.classList.remove("show");
        }

        // ---------- ç™»å…¥æª¢æŸ¥ + å³ä¸Šè§’ icon ----------
        const playerId = localStorage.getItem("playerId");
        if (!playerId) {
            window.location.href = "index.html";
        }

        const navIcon = document.getElementById("nav-profile-icon");
        if (navIcon) {
            const username = localStorage.getItem("username") || "ä½ ";
            navIcon.textContent = username.charAt(0).toUpperCase();
            navIcon.addEventListener("click", () => {
                window.location.href = "profile.html";
            });
        }

        // ---------- ã€Œä¸‹ä¸€ç«™ã€ Banner ----------
        function updateNextRaceBanner() {
            const infoEl = document.getElementById("next-race-info");
            if (!infoEl) return;

            apiGetNextRaceInfo().then(info => {
                if (!info) {
                    infoEl.textContent = "";
                    return;
                }

                if (info.isFinal) {
                    infoEl.textContent = `${info.year} è³½å­£ç›®å‰ç‹€æ…‹ï¼šFinal`;
                } else {
                    infoEl.textContent =
                        `${info.year} è³½å­£ä¸‹ä¸€ç«™ï¼š${info.trackName}ï¼ˆç¬¬ ${info.round} æˆ°ï¼Œ${info.raceDate}ï¼‰`;
                }
            });
        }

        // é€™å€‹åªçµ¦ç©åˆ†æŸ¥è©¢ç”¨ï¼Œä¸å½±éŸ¿ä¸‹ä¸€ç«™ Banner
        let currentYear = null;
        let yearSelectInitialized = false;
        let trackSelectInitialized = false;

        // ä¸€é€²é é¢å…ˆé¡¯ç¤ºä¸€æ¬¡æœ¬å­£ã€Œä¸‹ä¸€ç«™ã€
        (function initNextRaceBanner() {
            updateNextRaceBanner();
        })();

        // ---------- card å°è¦½ ----------
        const scoreSection = document.getElementById("score-section");
        const trackSection = document.getElementById("track-section");

        document.getElementById("card-score").addEventListener("click", () => {
            scoreSection.style.display = "block";
            trackSection.style.display = "none";
            initYearSelect();
        });

        document.getElementById("card-track").addEventListener("click", () => {
            trackSection.style.display = "block";
            scoreSection.style.display = "none";
            initTrackSelect();
        });

        // ---------- ç©åˆ†æ¦œï¼šå¹´åº¦é¸æ“‡ + ç©å®¶åæ¬¡æŸ¥è©¢ ----------
        function initYearSelect() {
            const sel = document.getElementById("year-select");

            if (!yearSelectInitialized) {
                yearSelectInitialized = true;

                apiGetYears().then(years => {
                    sel.innerHTML = "";
                    years.forEach(y => {
                        const opt = document.createElement("option");
                        opt.value = y;
                        opt.textContent = y;
                        sel.appendChild(opt);
                    });

                    if (years.length > 0) {
                        if (!currentYear) {
                            currentYear = years[years.length - 1];
                        }
                        sel.value = currentYear;
                        loadScoreBoard(currentYear);
                    }
                });

                sel.addEventListener("change", e => {
                    currentYear = e.target.value;
                    loadScoreBoard(currentYear);
                });

                document
                    .getElementById("rank-search-btn")
                    .addEventListener("click", () => {
                        const name = document
                            .getElementById("rank-search-name")
                            .value.trim();
                        const resultP = document.getElementById("rank-search-result");
                        if (!name) {
                            resultP.innerText = "è«‹è¼¸å…¥ç©å®¶å¸³è™Ÿã€‚";
                            return;
                        }
                        apiGetPlayerRankByYear(currentYear, name).then(info => {
                            if (!info) {
                                resultP.innerText = `åœ¨ ${currentYear} å¹´æ‰¾ä¸åˆ°å¸³è™Ÿã€Œ${name}ã€çš„ç´€éŒ„ã€‚`;
                            } else {
                                resultP.innerText =
                                    `åœ¨ ${currentYear} å¹´ï¼Œå¸³è™Ÿã€Œ${info.username}ã€ä½æ–¼ç¬¬ ${info.rank} åï¼Œç©åˆ†ç‚º ${info.score}ã€‚`;
                            }
                        });
                    });
            } else {
                currentYear = sel.value;
                loadScoreBoard(currentYear);
            }
        }

        function loadScoreBoard(year) {
            apiGetLeaderboardByYear(year).then(list => {
                const tbody = document.querySelector("#score-table tbody");
                tbody.innerHTML = "";
                list.forEach(item => {
                    const tr = document.createElement("tr");
                    tr.setAttribute("data-username", item.username);
                    tr.innerHTML = `
            <td>${item.rank}</td>
            <td>${item.username}</td>
            <td>${item.score}</td>
          `;
                    tr.addEventListener("click", () => {
                        showPlayerModal(item.username, item.rank, year);
                    });
                    tbody.appendChild(tr);
                });
            });
        }

        // ---------- è³½é“ç´€éŒ„ï¼šè³½é“ä¸‹æ‹‰ + æŸ¥ç©å®¶è³½é“ç´€éŒ„ ----------
        function initTrackSelect() {
            const sel = document.getElementById("track-select");

            if (!trackSelectInitialized) {
                trackSelectInitialized = true;

                apiGetTrackNames().then(names => {
                    sel.innerHTML = "";
                    names.forEach(name => {
                        const opt = document.createElement("option");
                        opt.value = name;
                        opt.textContent = name;
                        sel.appendChild(opt);
                    });
                    if (names.length > 0) {
                        loadTrackLeaderboard(names[0]);
                    }
                });

                sel.addEventListener("change", e => {
                    loadTrackLeaderboard(e.target.value);
                });

                document
                    .getElementById("track-player-btn")
                    .addEventListener("click", () => {
                        const name = document
                            .getElementById("track-player-name")
                            .value.trim();
                        const tbody = document.querySelector(
                            "#track-player-table tbody"
                        );
                        tbody.innerHTML = "";
                        if (!name) {
                            return;
                        }
                        apiGetPlayerTrackSummary(name).then(list => {
                            if (list.length === 0) {
                                const tr = document.createElement("tr");
                                tr.innerHTML =
                                    `<td colspan="5">æ‰¾ä¸åˆ°å¸³è™Ÿã€Œ${name}ã€çš„è³½é“ç´€éŒ„ã€‚</td>`;
                                tbody.appendChild(tr);
                            } else {
                                list.forEach(item => {
                                    const tr = document.createElement("tr");
                                    tr.innerHTML = `
                    <td>${item.trackName}</td>
                    <td>${item.username}</td>
                    <td>${item.rank}</td>
                    <td>${item.bestTime}</td>
                    <td>${item.points}</td>
                  `;
                                    tbody.appendChild(tr);
                                });
                            }
                        });
                    });
            } else {
                const firstTrack = sel.value;
                if (firstTrack) {
                    loadTrackLeaderboard(firstTrack);
                }
            }
        }

        function loadTrackLeaderboard(trackName) {
            apiGetTrackLeaderboard(trackName).then(list => {
                const tbody = document.querySelector("#track-table tbody");
                tbody.innerHTML = "";
                list.forEach(item => {
                    const tr = document.createElement("tr");
                    tr.setAttribute("data-username", item.username);
                    tr.innerHTML = `
            <td>${item.rank}</td>
            <td>${item.username}</td>
            <td>${item.bestTime}</td>
            <td>${item.points}</td>
          `;
                    tr.addEventListener("click", () => {
                        showPlayerModal(item.username);
                    });
                    tbody.appendChild(tr);
                });
            });
        }
    </script>
</body>

</html>