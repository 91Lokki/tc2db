<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>交易中心</title>
    <link rel="stylesheet" href="style.css">
    <script src="api.js"></script>
</head>

<body>
    <header class="site-header">
        <div class="header-inner">
            <div class="header-left">
                <div class="header-logo"> TC2 DB</div>
                <nav class="header-nav">
                    <a href="home.html" class="nav-link">首頁</a>
                    <a href="leaderboard.html" class="nav-link">排行榜</a>
                    <a href="trade.html" class="nav-link nav-link-active">交易中心</a>
                </nav>
            </div>

            <div class="header-right">
                <div class="profile-icon" id="nav-profile-icon"></div>
            </div>
        </div>
    </header>
    <div class="app">
        <div class="top-bar">
            <h1>交易中心</h1>
            <div class="top-bar-right">
                <span id="money-display" class="money-display">金幣：--</span>
            </div>
        </div>

        <div class="card-container">
            <div class="card" id="card-dealer">
                <h2>跟車商買車</h2>
                <p>選擇品牌，購買全新車款。</p>
            </div>

            <div class="card" id="card-used">
                <h2>玩家二手市場</h2>
                <p>查看其他玩家上架的二手車。</p>
            </div>
        </div>

        <section id="dealer-section" style="display:none; margin-top:30px;">
            <h2>車商品牌</h2>
            <div class="card-container" id="brand-container">
                </div>

            <h3 id="dealer-brief" style="margin-top:25px;">選擇品牌後的車款列表</h3>
            <table id="dealer-table">
                <thead>
                    <tr>
                        <th>車輛</th>
                        <th>品牌</th>
                        <th>國家</th>
                        <th>車款</th>
                        <th>價格</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="used-section" style="display:none; margin-top:30px;">
            <h2>玩家二手車列表</h2>
            <table id="used-table">
                <thead>
                    <tr>
                        <th>賣家</th>
                        <th>車輛</th>
                        <th>品牌</th>
                        <th>國家</th>
                        <th>價格</th>
                        <th>上架時間</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <p id="trade-msg"></p>
    </div>

    <script>
        // 檢查登入狀態
        const playerId = localStorage.getItem("playerId");
        if (!playerId) {
            window.location.href = "index.html";
        }

        // Header Icon
        const navIcon = document.getElementById("nav-profile-icon");
        if (navIcon) {
            const username = localStorage.getItem("username") || "你";
            navIcon.textContent = username.charAt(0).toUpperCase();
            navIcon.addEventListener("click", () => {
                window.location.href = "profile.html";
            });
        }

        // 品牌 Logo 對照 (如果 api.js 回傳的 logo_url 有效，這部分其實可以簡化，但留著當備用)
        const BRAND_LOGOS = {
            "Audi": "img/brands/audi.png",
            "BMW": "img/brands/bmw.png",
            "Ferrari": "img/brands/ferrari.png",
            "Honda": "img/brands/honda.png",
            "Lamborghini": "img/brands/lamborghini.png",
            "Mazda": "img/brands/mazda.png",
            "Mercedes-Benz": "img/brands/mercedes-benz.png",
            "Nissan": "img/brands/nissan.png",
            "Porsche": "img/brands/porsche.png",
            "Subaru": "img/brands/subaru.png",
            "Toyota": "img/brands/toyota.png",
            "Ford": "img/brands/ford.png",
            "Chevrolet": "img/brands/chevrolet.png",
            "Dodge": "img/brands/dodge.png"
        };

        function updateMoneyDisplay(money) {
            const el = document.getElementById("money-display");
            if (el && typeof money === "number") {
                el.innerText = `金幣：${money}`;
            }
        }

        // 初始讀取金錢
        apiGetProfile(playerId).then(user => {
            if (user && typeof user.money === "number") {
                updateMoneyDisplay(user.money);
            }
        });

        const dealerCard = document.getElementById("card-dealer");
        const usedCard = document.getElementById("card-used");
        const dealerSection = document.getElementById("dealer-section");
        const usedSection = document.getElementById("used-section");
        const tradeMsg = document.getElementById("trade-msg");

        // 切換：車商模式
        dealerCard.addEventListener("click", () => {
            dealerSection.style.display = "block";
            usedSection.style.display = "none";
            tradeMsg.innerText = "";
            loadDealerBrands();
        });

        // 切換：二手市場模式
        usedCard.addEventListener("click", () => {
            usedSection.style.display = "block";
            dealerSection.style.display = "none";
            tradeMsg.innerText = "";
            loadUsedCars();
        });

        // ----------------------------------------------------
        // 1. 車商功能
        // ----------------------------------------------------
        function loadDealerBrands() {
            const brandContainer = document.getElementById("brand-container");
            brandContainer.innerHTML = "";

            apiGetDealerBrands().then(brands => {
                // 依字母順序排序
                const sorted = [...brands].sort((a, b) =>
                    a.toLowerCase().localeCompare(b.toLowerCase())
                );

                sorted.forEach(brand => {
                    const div = document.createElement("div");
                    div.className = "card brand-card";
                    
                    // 這裡使用本地對照表的 logo，或者之後你可以改用 DB 裡的 logo_url
                    const logoSrc = BRAND_LOGOS[brand] || "img/brands/default.png";

                    div.innerHTML = `
                        <div class="brand-card-inner" style="display:flex;flex-direction:column;align-items:flex-start;gap:8px;">
                            <img class="brand-logo"
                                src="${logoSrc}"
                                alt="${brand} logo"
                                style="height:40px;object-fit:contain;">
                            <h2 style="margin:0;font-size:18px;">${brand}</h2>
                        </div>
                    `;

                    div.addEventListener("click", () => {
                        loadDealerCarsByBrand(brand);
                    });

                    brandContainer.appendChild(div);
                });
            });
        }

        function loadDealerCarsByBrand(brand) {
            apiGetDealerCarsByBrand(brand).then(cars => {
                const tbody = document.querySelector("#dealer-table tbody");
                tbody.innerHTML = "";
                
                // 更新標題
                const brief = document.getElementById("dealer-brief");
                if(brief) brief.innerText = `${brand} - 車款列表`;

                if (cars.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6">目前此品牌無新車可買</td></tr>`;
                    return;
                }

                cars.forEach(c => {
                    const tr = document.createElement("tr");
                    // 修正：使用新版 api.js 的欄位名稱
                    tr.innerHTML = `
                    <td>
                        <img src="${c.car_img || 'img/car-default.png'}"
                             alt="${c.model_name}"
                             class="car-thumb">
                    </td>
                    <td>
                        <div class="brand-cell">
                            <img src="${c.brand_logo || 'img/brand-default.png'}"
                                 alt="${c.brand}"
                                 class="brand-logo">
                            <span>${c.brand}</span>
                        </div>
                    </td>
                    <td>
                        <img src="${c.country_img || 'img/flag-default.png'}"
                             alt="country"
                             class="flag-icon">
                    </td>
                    <td>${c.model_name}</td>  <td>${c.base_price}</td>  <td>
                        <button class="buy-dealer-btn" data-id="${c.model_id}">購買</button>
                    </td>
                `;
                    tbody.appendChild(tr);
                });

                // 綁定購買事件
                tbody.querySelectorAll(".buy-dealer-btn").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const id = btn.getAttribute("data-id");
                        // 呼叫購買 API
                        apiBuyDealerCar(id).then(res => {
                            if (res && res.success) {
                                tradeMsg.className = "success-msg"; // 你可以在 CSS 加個綠色
                                tradeMsg.innerText = "購買成功！已向車商購買車輛。";
                                if (typeof res.money === "number") {
                                    updateMoneyDisplay(res.money);
                                }
                            } else {
                                tradeMsg.className = "error-msg";
                                tradeMsg.innerText = res && res.message ? res.message : "購買失敗";
                            }
                        });
                    });
                });
            });
        }

        // ----------------------------------------------------
        // 2. 二手市場功能
        // ----------------------------------------------------
        function loadUsedCars() {
            apiGetUsedCars().then(cars => {
                const tbody = document.querySelector("#used-table tbody");
                tbody.innerHTML = "";

                const myId = Number(playerId);

                if (cars.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7">目前沒有玩家上架二手車</td></tr>`;
                    return;
                }

                cars.forEach(c => {
                    // 不顯示自己的上架 (檢查 seller_id)
                    if (Number(c.seller_id) === myId) return;

                    // 上架時間 (listing_date)
                    let listedText = "—";
                    if (c.listing_date) {
                        const d = new Date(c.listing_date);
                        listedText = d.toLocaleString("zh-TW", {
                            timeZone: "Asia/Taipei",
                            hour12: false
                        });
                    }

                    // 修正：使用新版 api.js 的欄位名稱
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                    <td>${c.seller_name}</td>  <td>
                      <div class="car-cell">
                        <img src="${c.car_img || 'img/car-default.png'}"
                             alt="${c.model_name}"
                             class="car-thumb">
                        <div class="car-name">
                          ${c.brand_name} ${c.model_name} </div>
                      </div>
                    </td>
                    <td>
                      <div class="brand-cell">
                        <img src="${c.brand_logo || 'img/brand-default.png'}"
                             alt="${c.brand_name}"
                             class="brand-logo">
                        <span>${c.brand_name}</span>
                      </div>
                    </td>
                    <td>
                      <img src="${c.country_img || 'img/flag-default.png'}"
                           alt="country"
                           class="flag-icon">
                    </td>
                    <td>${c.sale_price}</td> <td>${listedText}</td>
                    <td>
                        <button class="buy-used-btn" data-id="${c.player_car_id}">買下</button>
                    </td>
                  `;
                    tbody.appendChild(tr);
                });

                // 綁定「買下」按鈕
                tbody.querySelectorAll(".buy-used-btn").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const id = btn.getAttribute("data-id");
                        apiBuyCar(id).then(res => {
                            if (res && res.success) {
                                tradeMsg.innerText = "購買成功！已從玩家買下車輛。";
                                if (typeof res.money === "number") {
                                    updateMoneyDisplay(res.money);
                                }
                                loadUsedCars(); // 重新整理列表
                            } else {
                                tradeMsg.innerText = res && res.message ? res.message : "購買失敗";
                            }
                        });
                    });
                });
            });
        }
    </script>
</body>

</html>