<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>è³½ç¨‹è¡¨æŸ¥è©¢</title>
    <link rel="stylesheet" href="style.css">
    <script src="api.js"></script>
</head>

<body>
    <header class="site-header">
        <div class="header-inner">
            <div class="header-left">
                <nav class="header-nav">
                    <a href="home.html" class="nav-link">HOME</a>
                    <a href="leaderboard.html" class="nav-link">LEADERBOARD</a>
                    <a href="trade.html" class="nav-link">SHOP</a>
                    <a href="schedule.html" class="nav-link nav-link-active">SCHEDULE</a>
                </nav>
            </div>
            <div class="header-right">
                <div class="profile-icon" id="nav-profile-icon"></div>
            </div>
        </div>
    </header>

    <div class="app">
        <div class="top-bar">
            <h1>è³½ç¨‹è¡¨æŸ¥è©¢</h1>
        </div>

        <div id="year-tabs" class="year-tabs" style="margin-top: 30px;">
        </div>

        <section id="schedule-section" style="margin-top: 30px;">
            <table id="schedule-table">
                <thead>
                    <tr>
                        <th style="width:10%;">å›åˆ</th>
                        <th style="width:20%;">è³½é“åç¨±</th>
                        <th style="width:10%;">è³½é“é•·åº¦</th>
                        <th style="width:15%;">æ—¥æœŸ</th>
                        <th style="width:10%;">ç¬¬ä¸€å</th>
                        <th style="width:10%;">ç¬¬äºŒå</th>
                        <th style="width:10%;">ç¬¬ä¸‰å</th>
                        <th style="width:15%;">ç‹€æ…‹</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

    </div>

    <script>
        const playerId = localStorage.getItem("playerId");
        if (!playerId) { window.location.href = "index.html"; }

        const navIcon = document.getElementById("nav-profile-icon");
        if (navIcon) {
            const username = localStorage.getItem("username") || "ä½ ";
            navIcon.textContent = username.charAt(0).toUpperCase();
            navIcon.addEventListener("click", () => { window.location.href = "profile.html"; });
        }

        let currentYear = null;
        const yearTabsContainer = document.getElementById("year-tabs");
        const scheduleBody = document.querySelector("#schedule-table tbody");

        function initYearTabs() {
            apiGetYears().then(years => {
                yearTabsContainer.innerHTML = "";

                // é è¨­é¸å–æœ€æ–°å¹´ä»½
                if (!currentYear || !years.includes(Number(currentYear))) {
                    currentYear = years[years.length - 1];
                }

                years.forEach(y => {
                    const tab = document.createElement("div");
                    tab.className = `year-tab ${y == currentYear ? 'active' : ''}`;
                    tab.textContent = y;
                    tab.addEventListener("click", () => {
                        document.querySelectorAll(".year-tab").forEach(t => t.classList.remove("active"));
                        tab.classList.add("active");
                        currentYear = y;
                        loadSchedule(currentYear);
                    });
                    yearTabsContainer.appendChild(tab);
                });

                // ç¢ºä¿æ²è»¸æ²åˆ°æœ€å³é‚Š (æœ€æ–°çš„å¹´ä»½)
                setTimeout(() => {
                    yearTabsContainer.scrollLeft = yearTabsContainer.scrollWidth;
                }, 100);

                loadSchedule(currentYear);
            });
        }

        // â˜… æ–°å¢ï¼šè¼‰å…¥è³½ç¨‹è¡¨è³‡æ–™çš„å‡½å¼
        // â˜… ä¿®æ­£ï¼šè¼‰å…¥è³½ç¨‹è¡¨è³‡æ–™çš„å‡½å¼ (åŒ…å«çµæœé¡¯ç¤º)
        function loadSchedule(year) {
            scheduleBody.innerHTML = `<tr><td colspan="8">è¼‰å…¥ ${year} å¹´è³½ç¨‹ä¸­...</td></tr>`; // colspan æ”¹ç‚º 8

            if (typeof apiGetScheduleByYear === 'function') {
                apiGetScheduleByYear(year).then(scheduleList => {
                    scheduleBody.innerHTML = "";
                    if (scheduleList.length === 0) {
                        scheduleBody.innerHTML = `<tr><td colspan="8">${year} å¹´åº¦å°šç„¡è³½ç¨‹è³‡æ–™ã€‚</td></tr>`;
                        return;
                    }

                    scheduleList.forEach(item => {
                        const tr = document.createElement("tr");
                        const statusText = item.is_completed ? "å·²å®Œæˆ âœ…" : "å³å°‡åˆ°ä¾† ğŸ—“ï¸";
                        const dateText = item.raceDate || 'å¾…å®š';
                        
                        // æ ¹æ“šç‹€æ…‹æ±ºå®šæ˜¯å¦é¡¯ç¤ºå‰ä¸‰å
                        const p1 = item.is_completed ? item.top1 : '-';
                        const p2 = item.is_completed ? item.top2 : '-';
                        const p3 = item.is_completed ? item.top3 : '-';
                        
                        tr.innerHTML = `
                            <td>Round ${item.round}</td>
                            <td>${item.trackName}</td>
                            <td>${item.trackLength}</td>
                            <td>${dateText}</td>
                            <td>${p1}</td>   <td>${p2}</td>   <td>${p3}</td>   <td>${statusText}</td>
                        `;
                        scheduleBody.appendChild(tr);
                    });
                }).catch(() => {
                    scheduleBody.innerHTML = `<tr><td colspan="8">ç„¡æ³•å–å¾—è³½ç¨‹è³‡æ–™ï¼Œè«‹æª¢æŸ¥ API é€£ç·šã€‚</td></tr>`;
                });
            } else {
                 scheduleBody.innerHTML = `<tr><td colspan="8">ç­‰å¾… apiGetScheduleByYear å‡½å¼å¯¦ä½œ...</td></tr>`;
            }
        }

        initYearTabs();
    </script>
</body>

</html>