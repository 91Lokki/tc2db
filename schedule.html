<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>è³½ç¨‹è¡¨æŸ¥è©¢</title>
    <link rel="stylesheet" href="style.css">
    <script src="api.js"></script>
    <style>
        /* --- å¹´ä»½é¸å–®æ¨£å¼ (èˆ‡ Leaderboard åŒæ­¥) --- */
        .year-tabs-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            max-width: 900px;
            margin: 30px auto;
            padding: 0 10px;
        }

        .year-tabs {
            flex: 1;
            overflow-x: auto;
            white-space: nowrap;
            text-align: center; /* è®“å¹´ä»½ç½®ä¸­ */
            scroll-behavior: smooth;
            /* éš±è—å·è»¸ */
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .year-tabs::-webkit-scrollbar { display: none; }

        /* å¹´ä»½æŒ‰éˆ•ï¼šç„¡æ¡†é¢¨æ ¼ */
        .year-tab {
            display: inline-block;
            padding: 10px 20px;
            font-size: 40px;
            font-weight: 700;
            color: #e0e0e0; /* æœªé¸ä¸­æ™‚æ˜¯æ·ºç°è‰² */
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .year-tab:hover {
            color: #999;
        }

        /* é¸ä¸­ç‹€æ…‹ï¼šæ·±é»‘è‰²ã€ç¨å¾®æ”¾å¤§ */
        .year-tab.active {
            color: #111;
            transform: scale(2);
        }

        /* å·¦å³ç®­é ­æŒ‰éˆ• */
        .tab-arrow {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
            background: #fff;
            color: #333;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .tab-arrow:hover { background: #f5f5f7; transform: scale(1.1); }
        .tab-arrow:active { background: #e5e5ea; transform: scale(0.95); }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="header-inner">
            <div class="header-left">
                <nav class="header-nav">
                    <a href="home.html" class="nav-link">HOME</a>
                    <a href="leaderboard.html" class="nav-link">LEADERBOARD</a>
                    <a href="trade.html" class="nav-link">SHOP</a>
                    <a href="schedule.html" class="nav-link nav-link-active">SCHEDULE</a>
                </nav>
            </div>
            <div class="header-right">
                <div class="profile-icon" id="nav-profile-icon"></div>
            </div>
        </div>
    </header>

    <div class="app">
        <div class="top-bar">
            <h1>Schedule Lookup</h1>
        </div>

        <div class="year-tabs-wrapper">
            <button id="tab-prev" class="tab-arrow">â€¹</button>
            <div id="year-tabs" class="year-tabs"></div>
            <button id="tab-next" class="tab-arrow">â€º</button>
        </div>

        <section id="schedule-section" style="margin-top: 30px;">
            <table id="schedule-table">
                <thead>
                    <tr>
                        <th style="width:10%;">å›åˆ</th>
                        <th style="width:25%;">è³½é“åç¨±</th>
                        <th style="width:15%;">æ—¥æœŸ</th>
                        <th style="width:10%;">ç¬¬ä¸€å</th>
                        <th style="width:10%;">ç¬¬äºŒå</th>
                        <th style="width:10%;">ç¬¬ä¸‰å</th>
                        <th style="width:20%;">ç‹€æ…‹</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

    </div>

    <script>
        const playerId = localStorage.getItem("playerId");
        // å…è¨±ä¸ç™»å…¥ç€è¦½ï¼Œåªåšé ­åƒåˆ‡æ›
        const isLoggedIn = !!playerId;

        const navIcon = document.getElementById("nav-profile-icon");
        if (navIcon) {
            if (isLoggedIn) {
                const username = localStorage.getItem("username") || "U";
                navIcon.textContent = username.charAt(0).toUpperCase();
                navIcon.onclick = () => window.location.href = "profile.html";
            } else {
                navIcon.textContent = "ç™»å…¥";
                navIcon.style.width = "auto";
                navIcon.style.borderRadius = "8px";
                navIcon.style.padding = "0 10px";
                navIcon.style.fontSize = "14px";
                navIcon.style.background = "#0071e3";
                navIcon.style.color = "white";
                navIcon.onclick = () => window.location.href = "login.html";
            }
        }

        let currentYear = null;
        const yearTabsContainer = document.getElementById("year-tabs");
        const scheduleBody = document.querySelector("#schedule-table tbody");

        function initYearTabs() {
            apiGetYears().then(years => {
                yearTabsContainer.innerHTML = "";
                
                // æ’åºï¼šå°åˆ°å¤§
                if(Array.isArray(years)) {
                    years.sort((a, b) => a - b);
                } else {
                    years = [2024];
                }

                // é è¨­é¸æœ€å¾Œä¸€å€‹ (æœ€æ–°çš„)
                if (!currentYear) {
                    currentYear = years[years.length - 1];
                }

                years.forEach(y => {
                    // è³½ç¨‹è¡¨é€šå¸¸ä¸éœ€è¦é¡¯ç¤º "all"
                    if(y === 'all') return;

                    const tab = document.createElement("div");
                    tab.className = 'year-tab'; // åŸºæœ¬æ¨£å¼
                    if (y == currentYear) tab.classList.add('active'); // é¸ä¸­æ¨£å¼
                    
                    tab.textContent = y;
                    
                    tab.addEventListener("click", () => {
                        // ç§»é™¤å…¶ä»–äººçš„ active
                        document.querySelectorAll(".year-tab").forEach(t => t.classList.remove("active"));
                        // è‡ªå·±åŠ ä¸Š active
                        tab.classList.add("active");
                        
                        // æ»¾å‹•ç½®ä¸­
                        tab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });

                        currentYear = y;
                        loadSchedule(currentYear);
                    });
                    yearTabsContainer.appendChild(tab);
                });

                // â˜… æ–°å¢ï¼šç®­é ­åŠŸèƒ½
                const btnPrev = document.getElementById("tab-prev");
                const btnNext = document.getElementById("tab-next");
                if(btnPrev) btnPrev.onclick = () => yearTabsContainer.scrollBy({ left: -200, behavior: 'smooth' });
                if(btnNext) btnNext.onclick = () => yearTabsContainer.scrollBy({ left: 200, behavior: 'smooth' });

                // è¼‰å…¥è³‡æ–™
                loadSchedule(currentYear);
            });
        }

        function loadSchedule(year) {
            scheduleBody.innerHTML = `<tr><td colspan="7">è¼‰å…¥ ${year} å¹´è³½ç¨‹ä¸­...</td></tr>`;

            apiGetScheduleByYear(year).then(scheduleList => {
                scheduleBody.innerHTML = "";
                
                if (!scheduleList || scheduleList.length === 0) {
                    scheduleBody.innerHTML = `<tr><td colspan="7">${year} å¹´åº¦å°šç„¡è³½ç¨‹è³‡æ–™ã€‚</td></tr>`;
                    return;
                }

                scheduleList.forEach(item => {
                    const tr = document.createElement("tr");
                    
                    let statusHtml = "";
                    if (item.isCompleted) {
                        statusHtml = `<span style="color:#34c759; font-weight:bold;">å·²å®Œè³½ âœ…</span>`;
                    } else {
                        statusHtml = `<span style="color:#ff9500; font-weight:bold;">å³å°‡åˆ°ä¾† ğŸ—“ï¸</span>`;
                    }

                    const dateText = item.raceDate || 'å¾…å®š';
                    const p1 = item.top1 || '-';
                    const p2 = item.top2 || '-';
                    const p3 = item.top3 || '-';
                    
                    tr.innerHTML = `
                        <td>Round ${item.roundNumber}</td>
                        <td>
                            <a href="leaderboard.html?mode=track&target=${encodeURIComponent(item.trackName)}" 
                               style="color:#0071e3; text-decoration:none; font-weight:600;">
                               ${item.trackName}
                            </a>
                        </td>
                        <td style="font-family:monospace;">${dateText}</td>
                        <td style="color:#d4af37; font-weight:600;">${p1}</td>
                        <td style="color:#c0c0c0; font-weight:600;">${p2}</td>
                        <td style="color:#cd7f32; font-weight:600;">${p3}</td>
                        <td>${statusHtml}</td>
                    `;
                    scheduleBody.appendChild(tr);
                });
            }).catch(err => {
                console.error(err);
                scheduleBody.innerHTML = `<tr><td colspan="7">ç„¡æ³•å–å¾—è³½ç¨‹è³‡æ–™ï¼Œè«‹æª¢æŸ¥å¾Œç«¯é€£ç·šã€‚</td></tr>`;
            });
        }

        initYearTabs();
    </script>
</body>

</html>