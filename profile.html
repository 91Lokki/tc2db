<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>å€‹äººè³‡æ–™</title>
    <link rel="stylesheet" href="style.css">
    <script src="api.js"></script>
</head>

<body>
    <header class="site-header">
        <div class="header-inner">
            <div class="header-left">
                <div class="header-logo">ï£¿ TC2 DB</div>
                <nav class="header-nav">
                    <a href="home.html" class="nav-link">é¦–é </a>
                    <a href="leaderboard.html" class="nav-link">æ’è¡Œæ¦œ</a>
                    <a href="trade.html" class="nav-link">äº¤æ˜“ä¸­å¿ƒ</a>
                    <a href="schedule.html" class="nav-link">è³½ç¨‹è¡¨</a>
                </nav>
            </div>
            <div class="header-right">
                <div class="profile-icon" id="nav-profile-icon"></div>
            </div>
        </div>
    </header>

    <div class="app">
        <h1 id="page-title">ç©å®¶å€‹äººè³‡æ–™</h1>

        <div id="profile-basic" style="margin-top:10px;"></div>

        <div id="edit-section" style="display:none; margin-top:15px;">
            <h2>Edit Profile</h2>
            <label>æ–°å¯†ç¢¼ï¼ˆç•™ç™½å‰‡ä¸æ›´æ”¹ï¼‰ï¼š<br><input type="password" id="edit-password"></label><br>
            <button id="save-profile">Save</button>
            <button id="cancel-edit">Cancel</button>
            <button id="delete-account"
                style="margin-left:12px;background:#ff3b30;color:#fff;border-color:#ff3b30;">åˆªé™¤å¸³è™Ÿ</button>
            <p id="edit-msg"></p>
        </div>

        <h2 style="margin-top:25px;">è»Šåº«</h2>
        <table id="car-table">
            <thead>
                <tr>
                    <th>å“ç‰Œ</th>
                    <th>è»Šæ¬¾</th>
                    <th>å–å¾—æ—¥æœŸ</th>
                    <th>é‡Œç¨‹æ•¸</th>
                    <th>åƒ¹æ ¼</th>
                    <th>ç®¡ç†</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2 style="margin-top:25px;">äº¤æ˜“æ­·å²ç´€éŒ„</h2>
        <table id="tx-table">
            <thead>
                <tr>
                    <th>æ™‚é–“</th>
                    <th>é¡å‹</th>
                    <th>å°è±¡</th>
                    <th>è»Šæ¬¾</th>
                    <th>é‡‘é¡</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const playerId = localStorage.getItem("playerId");
        if (!playerId) { window.location.href = "index.html"; }

        let currentUser = null;
        const navIcon = document.getElementById("nav-profile-icon");
        if (navIcon) {
            const username = localStorage.getItem("username") || "ä½ ";
            navIcon.textContent = username.charAt(0).toUpperCase();
            navIcon.addEventListener("click", () => { window.location.href = "profile.html"; });
        }

        const profileBasic = document.getElementById("profile-basic");
        const editSection = document.getElementById("edit-section");
        const editPasswordInput = document.getElementById("edit-password");
        const editMsg = document.getElementById("edit-msg");
        const txBody = document.querySelector("#tx-table tbody");

        function renderTransactions(transactions) {
            if (!txBody) return;
            txBody.innerHTML = "";
            const list = Array.isArray(transactions) ? [...transactions] : [];

            if (list.length === 0) {
                txBody.innerHTML = `<tr><td colspan="5">ç›®å‰å°šç„¡äº¤æ˜“ç´€éŒ„</td></tr>`;
                return;
            }

            list.forEach(t => {
                const timeText = t.time ? new Date(t.time).toLocaleString() : "-";
                let typeText = "-";
                switch (t.type) {
                    case "BUY_DEALER": typeText = "å“ç‰Œè»Šè³¼å…¥"; break;
                    case "BUY_USED": typeText = "äºŒæ‰‹è»Šè³¼å…¥"; break;
                    case "SELL_USED": typeText = "äºŒæ‰‹è»Šå”®å‡º"; break;
                    default: typeText = t.type || "-";
                }
                const tr = document.createElement("tr");
                tr.innerHTML = `
                  <td>${timeText}</td>
                  <td>${typeText}</td>
                  <td>${t.counterparty || "-"}</td>
                  <td>${t.desc || "-"}</td>
                  <td>${t.amount != null ? t.amount : "-"}</td>
                `;
                txBody.appendChild(tr);
            });
        }

        function renderProfile(user) {
            currentUser = user;
            if (!user) return;

            document.getElementById("page-title").innerText = user.username;

            let careerScore = user.totalScore || 0;
            const totalRaces = user.raceCount || 0;
            const winCount = user.winCount || 0;
            const silverCups = user.secCount || 0;
            const bronzeCups = user.trdCount || 0;
            const goldCups = winCount;
            let createdAtText = user.reg_date ? new Date(user.reg_date).toLocaleDateString("zh-TW") : "-";

            profileBasic.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:24px;">
                <div>
                  <p>ğŸ’°${user.money}</p>
                </div>
                <div style="text-align:right;">
                  <button id="edit-profile">Edit</button>
                  <button id="logout-btn" style="margin-left:8px;">ç™»å‡º</button>
                </div>
              </div>

              <div style="margin-top:20px;padding:24px;border-radius:18px;background:#ffffff;box-shadow:0 10px 24px rgba(0,0,0,0.06);">
                
                <div style="display:flex; flex-wrap:wrap; gap:40px; align-items:flex-start;">
                  
                  <div>
                    <div style="font-size:13px;color:#6e6e73; margin-bottom:4px;">ç›®å‰è³½å­£æ’å</div>
                    
                    <div>
                        <div id="stat-rank" style="font-size:32px;font-weight:700; line-height:1.2; color:#1d1d1f;">--</div>
                        <div id="stat-rank-year" style="font-size:13px;color:#8e8e93; margin-top:2px;"></div>
                    </div>
                  </div>

                  <div>
                    <div style="font-size:13px; margin-bottom:4px; visibility:hidden;">å ä½ç”¨æ¨™é¡Œ</div>
                    
                    <div style="font-size:32px; font-weight:700; line-height:1.2;">
                        ğŸ¥‡${goldCups} ğŸ¥ˆ${silverCups} ğŸ¥‰${bronzeCups}
                    </div>
                  </div>

                </div>

                <div style="display:flex;flex-wrap:wrap;gap:30px;margin-top:24px;padding-top:20px;border-top:1px solid #f5f5f7;">
                  <div><div style="font-size:12px;color:#6e6e73;">ç”Ÿæ¶¯ç¸½ç©åˆ†</div><div style="font-size:18px;font-weight:600;">${careerScore}</div></div>
                  <div><div style="font-size:12px;color:#6e6e73;">ç¸½åƒè³½æ¬¡æ•¸</div><div style="font-size:18px;font-weight:600;">${totalRaces}</div></div>
                  <div><div style="font-size:12px;color:#6e6e73;">åˆ†ç«™å† è»</div><div style="font-size:18px;font-weight:600;">${winCount}</div></div>
                  <div><div style="font-size:12px;color:#6e6e73;">è¨»å†Šæ—¥æœŸ</div><div style="font-size:16px;font-weight:500;">${createdAtText}</div></div>
                </div>
              </div>
            `;

            document.getElementById("edit-profile").addEventListener("click", () => editSection.style.display = "block");
            document.getElementById("logout-btn").addEventListener("click", () => {
                localStorage.removeItem("playerId");
                localStorage.removeItem("username");
                window.location.href = "index.html";
            });

            apiGetYears().then(years => {
                if (!years || years.length === 0) return;
                const targetYear = years[years.length - 1];
                const yearLabel = document.getElementById("stat-rank-year");
                if (yearLabel) yearLabel.textContent = `${targetYear} å¹´åº¦`;
                apiGetPlayerRankByYear(targetYear, user.username).then(info => {
                    const rankEl = document.getElementById("stat-rank");
                    if (rankEl) rankEl.textContent = (info && info.rank > 0) ? `ç¬¬ ${info.rank} å` : "--";
                });
            });

            // ---------------------------------------------------------
            // â–¼â–¼â–¼ æ–°çš„ç¨‹å¼ç¢¼é–‹å§‹ (è«‹å®Œæ•´è¤‡è£½è²¼ä¸Š) â–¼â–¼â–¼
            // ---------------------------------------------------------
            
            const carBody = document.querySelector("#car-table tbody");
            carBody.innerHTML = ""; // æ¸…ç©ºè¡¨æ ¼

            // 1. æŠŠè»Šå­åˆ†æˆå…©å †ï¼šæ­£åœ¨è³£çš„ (selling) å’Œ æ²’åœ¨è³£çš„ (idle)
            const sellingCars = (user.cars || []).filter(c => c.on_sale);
            const idleCars = (user.cars || []).filter(c => !c.on_sale);

            // 2. ç¬¬ä¸€å€ï¼šå…ˆé¡¯ç¤ºã€Œæ­£åœ¨è²©å”®ã€çš„è»Š (é»ƒè‰²åº•)
            if (sellingCars.length > 0) {
                // åŠ ä¸€å€‹æ¨™é¡Œåˆ—
                carBody.innerHTML += `
                    <tr style="background:#fff8e1; font-weight:bold; color:#d35400;">
                        <td colspan="7" style="text-align:left; padding-left:15px;">ğŸ”¥ å‡ºå”®</td>
                    </tr>`;

                sellingCars.forEach(c => {
                    const obtainDateStr = c.obtain_date ? new Date(c.obtain_date).toLocaleDateString("zh-TW") : "-";
                    const mileageText = c.mileage != null ? `${c.mileage} km` : "0 km";

                    carBody.innerHTML += `
                      <tr style="background-color: #fffdf5;">
                        <td>${c.brand_name || "æœªçŸ¥"}</td> 
                        <td>${c.model_name || "æœªçŸ¥"}</td>
                        <td>${obtainDateStr}</td>
                        <td>${mileageText}</td>
                        <td>$${c.sale_price}</td>
                        <td>
                          <button class="sell-btn" 
                                  data-id="${c.car_id}" 
                                  data-onsale="true" 
                                  style="background:#ff3b30; color:white; border:none; padding:6px 12px; border-radius:12px;">
                              ä¸‹æ¶
                          </button>
                        </td>
                      </tr>
                    `;
                });
            }

            // 3. ç¬¬äºŒå€ï¼šé¡¯ç¤ºã€Œè»Šåº«é–’ç½®ã€çš„è»Š (ç°è‰²åº•)
            if (idleCars.length > 0) {
                // åŠ ä¸€å€‹æ¨™é¡Œåˆ—
                carBody.innerHTML += `
                    <tr style="background:#f2f2f7; font-weight:bold; color:#666; border-top:3px solid #fff;">
                        <td colspan="7" style="text-align:left; padding-left:15px;">ğŸš— çè—</td>
                    </tr>`;
                
                idleCars.forEach(c => {
                    const obtainDateStr = c.obtain_date ? new Date(c.obtain_date).toLocaleDateString("zh-TW") : "-";
                    const mileageText = c.mileage != null ? `${c.mileage} km` : "0 km";

                    carBody.innerHTML += `
                      <tr>
                        <td>${c.brand_name || "æœªçŸ¥"}</td> 
                        <td>${c.model_name || "æœªçŸ¥"}</td>
                        <td>${obtainDateStr}</td>
                        <td>${mileageText}</td>
                        <td>-</td>
                        <td>
                          <button class="sell-btn" 
                                  data-id="${c.car_id}" 
                                  data-onsale="false"
                                  style="background:#0071e3; color:white; border:none; padding:6px 12px; border-radius:12px;">
                              ä¸Šæ¶
                          </button>
                        </td>
                      </tr>
                    `;
                });
            } else if (sellingCars.length === 0) {
                // å¦‚æœå…©é‚Šéƒ½æ²’è»Š
                carBody.innerHTML += `<tr><td colspan="7" style="text-align:center; color:#999; padding:20px;">è»Šåº«æ˜¯ç©ºçš„</td></tr>`;
            }

            // 4. è¨­å®šæŒ‰éˆ•åŠŸèƒ½ (é»æ“Šå¾Œåšä»€éº¼)
            carBody.querySelectorAll(".sell-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const carId = btn.getAttribute("data-id");
                    const isOnSale = btn.getAttribute("data-onsale") === "true"; // æª¢æŸ¥ç¾åœ¨æ˜¯ä¸æ˜¯ä¸Šæ¶ç‹€æ…‹

                    if (!isOnSale) {
                        // === åŸæœ¬æ²’è³£ï¼Œç¾åœ¨è¦ä¸Šæ¶ ===
                        const priceInput = prompt("è«‹è¼¸å…¥ä¸Šæ¶åƒ¹æ ¼ï¼š", "100000");
                        if (priceInput === null) return;
                        const price = Number(priceInput);
                        if (!Number.isFinite(price) || price <= 0) { alert("é‡‘é¡ä¸åˆæ³•"); return; }
                        
                        // å‘¼å« API ä¸Šæ¶ (true)
                        apiSetCarOnSale(playerId, carId, true, price).then(res => {
                            if (res && res.success) {
                                alert("ä¸Šæ¶æˆåŠŸï¼");
                                loadProfile(); // é‡æ–°æ•´ç†ç•«é¢
                            } else {
                                alert(res.message || "ä¸Šæ¶å¤±æ•—");
                            }
                        });

                    } else {
                        // === åŸæœ¬åœ¨è³£ï¼Œç¾åœ¨è¦å–æ¶ˆ ===
                        if(!confirm("ç¢ºå®šè¦å–æ¶ˆè²©å”®é€™å°è»Šå—ï¼Ÿ")) return;

                        // å‘¼å« API å–æ¶ˆ (false)
                        apiSetCarOnSale(playerId, carId, false, 0).then(res => {
                            if (res && res.success) {
                                alert("å·²å–æ¶ˆè²©å”®ï¼Œè»Šå­å›åˆ°è»Šåº«å›‰ï¼");
                                loadProfile(); // é‡æ–°æ•´ç†ç•«é¢
                            } else {
                                alert(res.message || "å–æ¶ˆå¤±æ•—");
                            }
                        });
                    }
                });
            });
            
            // ---------------------------------------------------------
            // â–²â–²â–² æ–°çš„ç¨‹å¼ç¢¼çµæŸ â–²â–²â–²
            // ---------------------------------------------------------

            apiGetTransactions(playerId).then(txs => renderTransactions(txs));
        }

        function loadProfile() {
            apiGetProfile(playerId).then(user => renderProfile(user));
        }

        document.getElementById("save-profile").addEventListener("click", () => {
            const newPassword = editPasswordInput.value;
            if (!newPassword) { editMsg.innerText = "æ²’æœ‰è¦ä¿®æ”¹çš„å…§å®¹"; return; }
            apiUpdateProfile(playerId, { password: newPassword }).then(user => {
                if (!user) { editMsg.innerText = "æ›´æ–°å¤±æ•—"; return; }
                editMsg.innerText = "æ›´æ–°æˆåŠŸ";
                editSection.style.display = "none";
                editPasswordInput.value = "";
                loadProfile();
            });
        });

        document.getElementById("cancel-edit").addEventListener("click", () => {
            editSection.style.display = "none";
            editPasswordInput.value = "";
            editMsg.innerText = "";
        });

        document.getElementById("delete-account").addEventListener("click", () => {
            if (!currentUser) return;
            if (!confirm("ç¢ºå®šè¦åˆªé™¤å¸³è™Ÿå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) return;
            apiDeleteAccount(playerId).then(res => {
                if (res && res.success) {
                    localStorage.removeItem("playerId");
                    localStorage.removeItem("username");
                    window.location.href = "index.html";
                } else {
                    editMsg.innerText = res.message || "åˆªé™¤å¤±æ•—";
                }
            });
        });

        loadProfile();
    </script>
</body>

</html>