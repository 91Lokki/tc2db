<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>å€‹äººè³‡æ–™</title>
    <link rel="stylesheet" href="style.css">
    <script src="api.js"></script>
</head>

<body>
    <header class="site-header">
        <div class="header-inner">
            <div class="header-left">
                <div class="header-logo">ï£¿ TC2 DB</div>
                <nav class="header-nav">
                    <a href="home.html" class="nav-link">é¦–é </a>
                    <a href="leaderboard.html" class="nav-link">æ’è¡Œæ¦œ</a>
                    <a href="trade.html" class="nav-link">äº¤æ˜“ä¸­å¿ƒ</a>
                </nav>
            </div>

            <div class="header-right">
                <div class="profile-icon" id="nav-profile-icon"></div>
            </div>
        </div>
    </header>

    <div class="app">
        <h1>ç©å®¶å€‹äººè³‡æ–™</h1>

        <div id="profile-basic" style="margin-top:10px;">
            </div>

        <div id="edit-section" style="display:none; margin-top:15px;">
            <h2>Edit Profile</h2>
            <label>
                æ–°å¯†ç¢¼ï¼ˆç•™ç™½å‰‡ä¸æ›´æ”¹ï¼‰ï¼š<br>
                <input type="password" id="edit-password">
            </label><br>
            <button id="save-profile">Save</button>
            <button id="cancel-edit">Cancel</button>
            <button id="delete-account" style="margin-left:12px;background:#ff3b30;color:#fff;border-color:#ff3b30;">
                åˆªé™¤å¸³è™Ÿ
            </button>
            <p id="edit-msg"></p>
        </div>

        <h2 style="margin-top:25px;">æ“æœ‰çš„è»Šå­</h2>
        <table id="car-table">
            <thead>
                <tr>
                    <th>å“ç‰Œ</th>
                    <th>è»Šæ¬¾</th>
                    <th>ç‹€æ…‹</th>
                    <th>åƒ¹æ ¼</th>
                    <th>ç®¡ç†</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2 style="margin-top:25px;">äº¤æ˜“æ­·å²ç´€éŒ„</h2>
        <table id="tx-table">
            <thead>
                <tr>
                    <th>æ™‚é–“</th>
                    <th>é¡å‹</th>
                    <th>å°è±¡</th>
                    <th>è»Šæ¬¾</th>
                    <th>é‡‘é¡</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const playerId = localStorage.getItem("playerId");
        if (!playerId) {
            window.location.href = "index.html";
        }

        let currentUser = null;

        // å³ä¸Šè§’åœ“å½¢ï¼šé¡¯ç¤º username ç¬¬ä¸€å€‹å­—
        const navIcon = document.getElementById("nav-profile-icon");
        if (navIcon) {
            const username = localStorage.getItem("username") || "ä½ ";
            navIcon.textContent = username.charAt(0).toUpperCase();
            navIcon.addEventListener("click", () => {
                window.location.href = "profile.html";
            });
        }

        const profileBasic = document.getElementById("profile-basic");
        const editSection = document.getElementById("edit-section");
        const editPasswordInput = document.getElementById("edit-password");
        const editMsg = document.getElementById("edit-msg");
        const txBody = document.querySelector("#tx-table tbody");

        // æ¸²æŸ“äº¤æ˜“ç´€éŒ„
        function renderTransactions(transactions) {
            if (!txBody) return;

            txBody.innerHTML = "";
            const list = Array.isArray(transactions) ? [...transactions] : [];

            if (list.length === 0) {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td colspan="5">ç›®å‰å°šç„¡äº¤æ˜“ç´€éŒ„</td>`;
                txBody.appendChild(tr);
                return;
            }

            list.forEach(t => {
                const timeText = t.time ? new Date(t.time).toLocaleString() : "-";
                let typeText = "-";
                switch (t.type) {
                    case "BUY_DEALER":
                        typeText = "å“ç‰Œè»Šè³¼å…¥";
                        break;
                    case "BUY_USED":
                        typeText = "äºŒæ‰‹è»Šè³¼å…¥";
                        break;
                    case "SELL_USED":
                        typeText = "äºŒæ‰‹è»Šå”®å‡º";
                        break;
                    default:
                        typeText = t.type || "-";
                }
                const tr = document.createElement("tr");
                tr.innerHTML = `
                  <td>${timeText}</td>
                  <td>${typeText}</td>
                  <td>${t.counterparty || "-"}</td>
                  <td>${t.desc || "-"}</td>
                  <td>${t.amount != null ? t.amount : "-"}</td>
                `;
                txBody.appendChild(tr);
            });
        }

        // æ¸²æŸ“åŸºæœ¬è³‡è¨Š + ç”Ÿæ¶¯æ•¸æ“š + è»Šå­åˆ—è¡¨
        function renderProfile(user) {
            currentUser = user;
            if (!user) return;

            let careerScore = user.totalScore || 0;
            const totalRaces = user.raceCount || 0;
            const winCount = user.winCount || 0;   
            const silverCups = user.secCount || 0;
            const bronzeCups = user.trdCount || 0;
            const goldCups = winCount;
            const podiumCount = goldCups + silverCups + bronzeCups;

            let createdAtText = "-";
            if (user.reg_date) {
                createdAtText = new Date(user.reg_date).toLocaleDateString("zh-TW");
            }

            // â˜… ä¿®æ”¹ 1ï¼šç§»é™¤äº† <p>ç›®å‰å¹´åº¦ç¸½ç©åˆ†ï¼š...</p>
            profileBasic.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:24px;">
                <div>
                  <p>å¸³è™Ÿ (ID)ï¼š${user.username}</p>
                  <p>é‡‘å¹£ï¼š${user.money}</p>
                </div>
                <div style="text-align:right;">
                  <button id="edit-profile">Edit</button>
                  <button id="logout-btn" style="margin-left:8px;">ç™»å‡º</button>
                </div>
              </div>

              <div style="margin-top:20px;padding:16px 18px;border-radius:18px;background:#ffffff;
                          box-shadow:0 10px 24px rgba(0,0,0,0.06);border:1px solid rgba(0,0,0,0.04);">
                <div style="display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;justify-content:space-between;">
                  <div style="min-width:220px;">
                    <div style="font-size:13px;color:#6e6e73;margin-bottom:4px;">ç›®å‰å¹´åº¦ç©åˆ†æ’å</div>
                    <div id="stat-rank" style="font-size:28px;font-weight:700;color:#111111;letter-spacing:0.03em;">--</div>
                    <div id="stat-rank-year" style="font-size:12px;color:#8e8e93;margin-top:2px;"></div>
                  </div>
                  <div style="flex:1;min-width:260px;">
                    <div style="font-size:13px;color:#6e6e73;margin-bottom:4px;">é‡‘ / éŠ€ / éŠ…ç›ƒ æ¬¡æ•¸</div>
                    <div style="font-size:24px;font-weight:700;display:flex;gap:18px;flex-wrap:wrap;">
                      <span>ğŸ¥‡ <span id="stat-gold">${goldCups}</span></span>
                      <span>ğŸ¥ˆ <span id="stat-silver">${silverCups}</span></span>
                      <span>ğŸ¥‰ <span id="stat-bronze">${bronzeCups}</span></span>
                    </div>
                  </div>
                </div>

                <div style="display:flex;flex-wrap:wrap;gap:18px;margin-top:18px;">
                  <div style="min-width:140px;">
                    <div style="font-size:12px;color:#6e6e73;">ç”Ÿæ¶¯ç¸½ç©åˆ†</div>
                    <div id="stat-career-score" style="font-size:18px;font-weight:600;">${careerScore}</div>
                  </div>
                  <div style="min-width:140px;">
                    <div style="font-size:12px;color:#6e6e73;">ç¸½åƒè³½æ¬¡æ•¸</div>
                    <div id="stat-total-races" style="font-size:18px;font-weight:600;">${totalRaces}</div>
                  </div>
                  <div style="min-width:140px;">
                    <div style="font-size:12px;color:#6e6e73;">åˆ†ç«™å† è»æ¬¡æ•¸</div>
                    <div id="stat-wins" style="font-size:18px;font-weight:600;">${winCount}</div>
                  </div>
                  <div style="min-width:140px;">
                    <div style="font-size:12px;color:#6e6e73;">ä¸Šçå°æ¬¡æ•¸</div>
                    <div id="stat-podiums" style="font-size:18px;font-weight:600;">${podiumCount}</div>
                  </div>
                  <div style="min-width:160px;">
                    <div style="font-size:12px;color:#6e6e73;">è¨»å†Šæ—¥æœŸ</div>
                    <div id="stat-created" style="font-size:16px;font-weight:500;">${createdAtText}</div>
                  </div>
                </div>
              </div>
            `;

            // Edit æŒ‰éˆ•äº‹ä»¶
            document.getElementById("edit-profile").addEventListener("click", () => {
                editSection.style.display = "block";
            });

            // ç™»å‡º
            document.getElementById("logout-btn").addEventListener("click", () => {
                localStorage.removeItem("playerId");
                localStorage.removeItem("username");
                window.location.href = "index.html";
            });

            // æ›´æ–°æ’å
            apiGetYears().then(years => {
                if (!years || years.length === 0) return;
                const latestYear = years[years.length - 1];
                const yearLabel = document.getElementById("stat-rank-year");
                if (yearLabel) yearLabel.textContent = `${latestYear} å¹´åº¦`;
                
                apiGetPlayerRankByYear(latestYear, user.username).then(info => {
                    const rankEl = document.getElementById("stat-rank");
                    if (!rankEl) return;
                    // â˜… ä¿®æ”¹ 2ï¼šå¦‚æœåæ¬¡æ˜¯ 0 æˆ–ä¸å­˜åœ¨ï¼Œé¡¯ç¤º "--"ï¼Œå¦å‰‡é¡¯ç¤º "ç¬¬ X å"
                    if (info && info.rank > 0) {
                        rankEl.textContent = `ç¬¬ ${info.rank} å`;
                    } else {
                        rankEl.textContent = "--";
                    }
                });
            });

            // è»Šå­åˆ—è¡¨
            const carBody = document.querySelector("#car-table tbody");
            carBody.innerHTML = "";
            (user.cars || []).forEach(c => {
                const onSale = c.on_sale;
                const carId = c.car_id;
                
                const statusText = onSale ? "å·²ä¸Šæ¶åˆ°äºŒæ‰‹å¸‚å ´" : "æŒæœ‰ä¸­";
                const btnText = onSale ? "å–æ¶ˆä¸Šæ¶" : "ä¸Šæ¶åˆ°äºŒæ‰‹å¸‚å ´";
                const priceDisplay = onSale ? c.sale_price : "-";

                carBody.innerHTML += `
                  <tr>
                    <td>${c.brand_name || "æœªçŸ¥å“ç‰Œ"}</td>
                    <td>${c.model_name || "æœªçŸ¥è»Šæ¬¾"}</td>
                    <td>${statusText}</td>
                    <td>${priceDisplay}</td>
                    <td>
                      <button class="sell-btn"
                              data-id="${carId}"
                              data-onsale="${onSale}">
                        ${btnText}
                      </button>
                    </td>
                  </tr>
                `;
            });

            // ç¶å®šæŒ‰éˆ•
            carBody.querySelectorAll(".sell-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const carId = btn.getAttribute("data-id");
                    const onSale = btn.getAttribute("data-onsale") === "true";

                    if (!onSale) {
                        const priceInput = prompt("è«‹è¼¸å…¥ä¸Šæ¶åƒ¹æ ¼ï¼š", "100000");
                        if (priceInput === null) return;

                        const price = Number(priceInput);
                        if (!Number.isFinite(price) || price <= 0) {
                            alert("é‡‘é¡ä¸åˆæ³•");
                            return;
                        }

                        apiSetCarOnSale(playerId, carId, true, price).then(res => {
                            if (res && res.success) {
                                loadProfile();
                            } else {
                                alert(res && res.message ? res.message : "ä¸Šæ¶å¤±æ•—");
                            }
                        });
                    } else {
                        apiSetCarOnSale(playerId, carId, false, 0).then(res => {
                            if (res && res.success) {
                                loadProfile();
                            } else {
                                alert(res && res.message ? res.message : "å–æ¶ˆä¸Šæ¶å¤±æ•—");
                            }
                        });
                    }
                });
            });

            // äº¤æ˜“ç´€éŒ„
            apiGetTransactions(playerId).then(txs => {
                renderTransactions(txs);
            });
        }

        // è®€å–å€‹äººè³‡æ–™
        function loadProfile() {
            apiGetProfile(playerId).then(user => {
                renderProfile(user);
            });
        }

        // å„²å­˜ç·¨è¼¯
        document.getElementById("save-profile").addEventListener("click", () => {
            const newPassword = editPasswordInput.value;
            editMsg.innerText = "";
            const updateData = {};
            if (newPassword) updateData.password = newPassword;

            if (!updateData.password) {
                editMsg.innerText = "æ²’æœ‰è¦ä¿®æ”¹çš„å…§å®¹";
                return;
            }

            apiUpdateProfile(playerId, updateData).then(user => {
                if (!user) {
                    editMsg.innerText = "æ›´æ–°å¤±æ•—";
                    return;
                }
                editMsg.innerText = "æ›´æ–°æˆåŠŸ";
                editSection.style.display = "none";
                editPasswordInput.value = "";
                loadProfile();
            });
        });

        document.getElementById("cancel-edit").addEventListener("click", () => {
            editSection.style.display = "none";
            editPasswordInput.value = "";
            editMsg.innerText = "";
        });

        document.getElementById("delete-account").addEventListener("click", () => {
            if (!currentUser) return;
            const ok = confirm("ç¢ºå®šè¦åˆªé™¤å¸³è™Ÿå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚");
            if (!ok) return;

            apiDeleteAccount(playerId).then(res => {
                if (!res || !res.success) {
                    editMsg.innerText = (res && res.message) ? res.message : "åˆªé™¤å¤±æ•—";
                    return;
                }
                localStorage.removeItem("playerId");
                localStorage.removeItem("username");
                window.location.href = "index.html";
            });
        });

        loadProfile();
    </script>
</body>

</html>