<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>å€‹äººè³‡æ–™</title>
    <link rel="stylesheet" href="style.css">
    <script src="api.js"></script>
    <style>
        /* åœ–ç‰‡æ¨£å¼ */
        .car-thumb-small {
            width: 60px;
            height: 36px;
            object-fit: cover;
            border-radius: 4px;
            vertical-align: middle;
            margin-right: 8px;
        }
        .flag-icon-small {
            width: 24px; /* ç¨å¾®åŠ å¤§ä¸€é»é» */
            height: auto;
            border-radius: 2px;
            vertical-align: middle;
            margin-right: 8px; /* èˆ‡æ–‡å­—æ‹‰é–‹è·é›¢ */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        /* è®“å“ç‰Œæ¬„ä½å…§å®¹æ°´å¹³æ’åˆ— */
        .brand-cell {
            display: flex;
            align-items: center;
            justify-content: center; /* å¦‚æœæƒ³è¦ç½®ä¸­ */
        }
        .car-name-cell {
            display: flex;
            align-items: center;
        }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="header-inner">
            <div class="header-left">
                <nav class="header-nav">
                    <a href="home.html" class="nav-link">HOME</a>
                </nav>
            </div>
            <div class="header-right">
                <div class="profile-icon" id="nav-profile-icon"></div>
            </div>
        </div>
    </header>

    <div class="app">
        <h1 id="page-title">ç©å®¶å€‹äººè³‡æ–™</h1>

        <div id="profile-basic" style="margin-top:10px;"></div>

        <div id="edit-section" style="display:none; margin-top:15px; background:#fff; padding:20px; border-radius:16px;">
            <h2 style="margin-top:0;">ä¿®æ”¹å¯†ç¢¼</h2>
            
            <div style="margin-bottom:10px;">
                <label style="font-weight:bold; font-size:13px;">èˆŠå¯†ç¢¼ (å¿…å¡«)ï¼š</label><br>
                <input type="password" id="old-password" class="filter-input" style="width:100%; max-width:300px;">
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="font-weight:bold; font-size:13px;">æ–°å¯†ç¢¼ï¼š</label><br>
                <input type="password" id="new-password" class="filter-input" style="width:100%; max-width:300px;">
            </div>

            <button id="save-profile">å„²å­˜è®Šæ›´</button>
            <button id="cancel-edit">å–æ¶ˆ</button>
            
            <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">
            
            <button id="delete-account" style="background:#ff3b30; color:#fff; border-color:#ff3b30;">åˆªé™¤å¸³è™Ÿ (å±éšª)</button>
            <p id="edit-msg" style="margin-top:10px; font-weight:bold;"></p>
        </div>

        <h2 style="margin-top:25px;">Garage</h2>
        <table id="car-table">
            <thead>
                <tr>
                    <th style="width: 25%;">è»Šæ¬¾</th>
                    <th style="width: 10%;">å¹´ä»½</th>
                    <th style="width: 15%;">å“ç‰Œ</th>
                    <th style="width: 10%;">é‡Œç¨‹æ•¸</th>
                    <th style="width: 15%;">åƒ¹æ ¼</th>
                    <th style="width: 15%;">ä¸Šæ¶æ™‚é–“</th>
                    <th style="width: 10%;">ç®¡ç†</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2 style="margin-top:25px;">Transcation History</h2>
        <table id="tx-table">
            <thead>
                <tr>
                    <th>æ™‚é–“</th>
                    <th>é¡å‹</th>
                    <th>èªªæ˜</th>
                    <th>é‡‘é¡</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const playerId = localStorage.getItem("playerId");
        // å…è¨±ä¸ç™»å…¥ç€è¦½ï¼Œä½†å¦‚æœè¦çœ‹è‡ªå·±è³‡æ–™é ˆç™»å…¥
        if (!playerId) { window.location.href = "login.html"; }

        let currentUser = null;
        
        const navIcon = document.getElementById("nav-profile-icon");
        if (navIcon) {
            const username = localStorage.getItem("username") || "ä½ ";
            navIcon.textContent = username.charAt(0).toUpperCase();
            navIcon.addEventListener("click", () => { window.location.href = "profile.html"; });
        }

        const profileBasic = document.getElementById("profile-basic");
        const editSection = document.getElementById("edit-section");
        const oldPassInput = document.getElementById("old-password");
        const newPassInput = document.getElementById("new-password");
        const editMsg = document.getElementById("edit-msg");
        const txBody = document.querySelector("#tx-table tbody");
        const carBody = document.querySelector("#car-table tbody");

        function loadProfile() {
            apiGetProfile(playerId).then(user => {
                if(user) renderProfile(user);
            });
        }

       function renderProfile(user) {
            currentUser = user;
            document.getElementById("page-title").innerText = user.username;

            let careerScore = user.totalScore || 0;
            const totalRaces = user.raceCount || 0;
            
            const raceWins = user.raceWins || 0;
            
            // â˜… æ–°å¢ï¼šè®€å–è®Šæ•¸
            const podiums = user.podiums || 0;

            const goldCups = user.seasonGold || 0;
            const silverCups = user.seasonSilver || 0;
            const bronzeCups = user.seasonBronze || 0;
            
            let regDateText = user.reg_date ? new Date(user.reg_date).toLocaleDateString("zh-TW") : "-";

            profileBasic.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:24px;">
                <div>
                  <p class="money-display">ğŸ’°${user.money != null ? user.money.toLocaleString() : 0}</p>
                </div>
                <div style="text-align:right;">
                  <button id="edit-btn">è¨­å®š / ä¿®æ”¹å¯†ç¢¼</button>
                  <button id="logout-btn" style="margin-left:8px;">ç™»å‡º</button>
                </div>
              </div>

              <div style="margin-top:20px;padding:24px;border-radius:18px;background:#ffffff;box-shadow:0 10px 24px rgba(0,0,0,0.06);">
                <div style="display:flex; flex-wrap:wrap; gap:40px; align-items:flex-start;">
                  <div>
                    <div style="font-size:13px;color:#6e6e73; margin-bottom:4px;">è³½å­£æ’å</div>
                    <div>
                        <div id="stat-rank" style="font-size:32px;font-weight:700; line-height:1.2; color:#1d1d1f;">--</div>
                        <div id="stat-rank-year" style="font-size:13px;color:#8e8e93; margin-top:2px;"></div>
                    </div>
                  </div>
                  <div>
                    <div style="font-size:13px; margin-bottom:4px; color:#6e6e73;">ç”Ÿæ¶¯çç›ƒ</div>
                    <div style="font-size:32px; font-weight:700; line-height:1.2;">
                        ğŸ¥‡${goldCups} ğŸ¥ˆ${silverCups} ğŸ¥‰${bronzeCups}
                    </div>
                  </div>
                </div>
                
                <div style="display:flex;flex-wrap:wrap;gap:30px;margin-top:24px;padding-top:20px;border-top:1px solid #f5f5f7;">
                  <div><div style="font-size:12px;color:#6e6e73;">ç”Ÿæ¶¯ç¸½ç©åˆ†</div><div style="font-size:18px;font-weight:600;">${careerScore}</div></div>
                  <div><div style="font-size:12px;color:#6e6e73;">å®Œè³½æ¬¡æ•¸</div><div style="font-size:18px;font-weight:600;">${totalRaces}</div></div>
                  
                  <div><div style="font-size:12px;color:#6e6e73;">åˆ†ç«™å† è»</div><div style="font-size:18px;font-weight:600;">${raceWins}</div></div>
                  
                  <div><div style="font-size:12px;color:#6e6e73;">é ’çå°</div><div style="font-size:18px;font-weight:600;">${podiums}</div></div>

                  <div><div style="font-size:12px;color:#6e6e73;">è¨»å†Šæ—¥æœŸ</div><div style="font-size:16px;font-weight:500;">${regDateText}</div></div>
                </div>
              </div>
            `;
            
            // ... (å¾Œé¢çš„ä»£ç¢¼ä¿æŒä¸è®Š) ...

            document.getElementById("edit-btn").addEventListener("click", () => editSection.style.display = "block");
            document.getElementById("logout-btn").addEventListener("click", () => {
                localStorage.removeItem("authToken"); 
                localStorage.removeItem("playerId");
                localStorage.removeItem("username");
                window.location.href = "index.html";
            });

            // å–å¾—ç›®å‰æ’å
            apiGetYears().then(years => {
                if (!years || years.length === 0) return;
                const validYears = years.filter(y => y !== 'all');
                const targetYear = validYears[validYears.length - 1] || 2024;
                
                const yearLabel = document.getElementById("stat-rank-year");
                if (yearLabel) yearLabel.textContent = `${targetYear} å¹´åº¦`;
                
                apiGetPlayerRankByYear(targetYear, user.username).then(info => {
                    const rankEl = document.getElementById("stat-rank");
                    if (rankEl) rankEl.textContent = (info && info.rank > 0) ? `ç¬¬ ${info.rank} å` : "-";
                });
            });

            // 2. æ¸²æŸ“è»Šåº«
            renderGarage(user.cars);

            // 3. æ¸²æŸ“äº¤æ˜“ç´€éŒ„
            renderTransactions(user.transactions);
        }

        function renderGarage(cars) {
            carBody.innerHTML = "";
            const list = cars || [];
            
            const selling = list.filter(c => c.on_sale);
            const idle = list.filter(c => !c.on_sale);

            if (list.length === 0) {
                carBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px; color:#999;">è»Šåº«ç©ºç©ºå¦‚ä¹Ÿ</td></tr>`;
                return;
            }

            const addRow = (c, bgColor) => {
                let listingText = "-";
                if(c.on_sale && c.listing_date) {
                    const d = new Date(c.listing_date);
                    if(!isNaN(d.getTime())) listingText = d.toLocaleString("zh-TW");
                }

                const priceText = c.on_sale ? `$${c.sale_price.toLocaleString()}` : "-";
                const btnColor = c.on_sale ? "#ff3b30" : "#0071e3";
                const btnText = c.on_sale ? "ä¸‹æ¶" : "ä¸Šæ¶";
                
                const carImgSrc = c.car_img || "img/car-default.png";
                const flagImgSrc = c.country_img || "img/flag-default.png";

                carBody.innerHTML += `
                    <tr style="background-color: ${bgColor};">
                        <td>
                            <div class="car-name-cell">
                                <img src="${carImgSrc}" class="car-thumb-small">
                                <span>${c.model_name}</span>
                            </div>
                        </td>
                        <td>${c.model_year || "-"}</td>
                        <td>
                            <div class="brand-cell">
                                <img src="${flagImgSrc}" class="flag-icon-small">
                                <span>${c.brand_name}</span>
                            </div>
                        </td>
                        <td>${c.mileage.toLocaleString()} km</td>
                        <td style="font-weight:bold;">${priceText}</td>
                        <td style="font-size:12px; color:#666;">${listingText}</td>
                        <td>
                            <button class="action-btn" 
                                data-id="${c.car_id}" 
                                data-sale="${c.on_sale}"
                                style="background:${btnColor}; color:white; border:none; padding:6px 12px; border-radius:12px;">
                                ${btnText}
                            </button>
                        </td>
                    </tr>
                `;
            };

            if(selling.length > 0) {
                carBody.innerHTML += `<tr style="background:#fff8e1; color:#d35400; font-weight:bold;"><td colspan="7">ğŸ”¥ è²©å”®ä¸­</td></tr>`;
                selling.forEach(c => addRow(c, "#fffdf5"));
            }
            if(idle.length > 0) {
                carBody.innerHTML += `<tr style="background:#f2f2f7; color:#666; font-weight:bold;"><td colspan="7">ğŸš— æ”¶è—</td></tr>`;
                idle.forEach(c => addRow(c, "#fff"));
            }

            // ç¶å®šæŒ‰éˆ•
            carBody.querySelectorAll(".action-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const carId = btn.getAttribute("data-id");
                    const isSale = btn.getAttribute("data-sale") === "true";
                    
                    if (isSale) {
                        if(!confirm("ç¢ºå®šè¦ä¸‹æ¶é€™å°è»Šå—ï¼Ÿ")) return;
                        apiSetCarOnSale(playerId, carId, false, 0).then(res => {
                            if(res.success) { alert("å·²ä¸‹æ¶"); loadProfile(); }
                            else alert(res.message || "æ“ä½œå¤±æ•—");
                        });
                    } else {
                        const price = prompt("è«‹è¼¸å…¥å”®åƒ¹ï¼š", "100000");
                        if(!price) return;
                        apiSetCarOnSale(playerId, carId, true, price).then(res => {
                            if(res.success) { alert("ä¸Šæ¶æˆåŠŸ"); loadProfile(); }
                            else alert(res.message || "æ“ä½œå¤±æ•—");
                        });
                    }
                });
            });
        }

        function renderTransactions(txs) {
            txBody.innerHTML = "";
            const list = txs || [];
            if (list.length === 0) {
                txBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">ç„¡äº¤æ˜“ç´€éŒ„</td></tr>`;
                return;
            }
            list.forEach(t => {
                const dateStr = t.time ? new Date(t.time).toLocaleString() : "-";
                const color = t.amount < 0 ? "#ff3b30" : "#34c759";
                const amountStr = t.amount != null ? t.amount.toLocaleString() : "-";
                
                txBody.innerHTML += `
                    <tr>
                        <td>${dateStr}</td>
                        <td>${t.type}</td>
                        <td>${t.desc || "-"}</td>
                        <td style="color:${color}; font-weight:bold;">${amountStr}</td>
                    </tr>
                `;
            });
        }

        document.getElementById("save-profile").addEventListener("click", () => {
            const oldP = oldPassInput.value;
            const newP = newPassInput.value;
            
            if(!oldP) {
                editMsg.innerText = "è«‹è¼¸å…¥èˆŠå¯†ç¢¼ä»¥é©—è­‰èº«åˆ†";
                editMsg.style.color = "red";
                return;
            }
            if(!newP) {
                editMsg.innerText = "æ–°å¯†ç¢¼ä¸èƒ½ç‚ºç©º";
                return;
            }

            apiUpdateProfile(playerId, { oldPassword: oldP, newPassword: newP }).then(res => {
                if(res.success) {
                    editMsg.innerText = "å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼";
                    editMsg.style.color = "green";
                    oldPassInput.value = "";
                    newPassInput.value = "";
                } else {
                    editMsg.innerText = res.message || "ä¿®æ”¹å¤±æ•—ï¼ŒèˆŠå¯†ç¢¼å¯èƒ½éŒ¯èª¤";
                    editMsg.style.color = "red";
                }
            });
        });

        document.getElementById("cancel-edit").addEventListener("click", () => {
            editSection.style.display = "none";
            editMsg.innerText = "";
        });

        document.getElementById("delete-account").addEventListener("click", () => {
            if(!confirm("è­¦å‘Šï¼šç¢ºå®šè¦æ°¸ä¹…åˆªé™¤å¸³è™Ÿå—ï¼Ÿè³‡æ–™å°‡ç„¡æ³•å¾©åŸï¼")) return;
            
            apiDeleteAccount(playerId).then(res => {
                if(res.success) {
                    alert("å¸³è™Ÿå·²åˆªé™¤");
                    localStorage.clear();
                    window.location.href = "index.html";
                } else {
                    alert(res.message || "åˆªé™¤å¤±æ•—");
                }
            });
        });

        loadProfile();
    </script>
</body>
</html>
